{% extends 'layout.html' %}
{% set title = 'Adviser Earliest Availability' %}

{% block content %}
<div class="topbar">
  <div style="display: flex; align-items: center; gap: 16px;">
    <a href="/" style="color: #d0d7e2; text-decoration: none; font-size: 0.9em;">‚Üê Home</a>
    <h2>Adviser Earliest Availability</h2>
  </div>
  <div class="datebox"><span>Today: {{ today }}</span><span>Week: {{ week_num }}</span></div>
</div>

<div class="card guide-card">
  <div class="card-header">
    <h3>Compute Availability</h3>
    <label class="helper-toggle" title="Toggle helper content">
      <input type="checkbox" id="toggleHelpers" checked />
      Show helper tips
    </label>
  </div>
  <p class="muted inline-guide-title">Quick guide</p>
  <ul class="inline-guide">
    <li>Select the agreement start date to centre the availability window.</li>
    <li>Toggle ‚ÄúInclude Non-Taking Advisers‚Äù when you need to review advisers on pause.</li>
    <li>Sort any column to compare earliest week, client limits, or service package tags.</li>
  </ul>
  <div class="row">
    <div>
      <label for="agreementStartDate">Agreement Start Date</label>
      <input type="date" id="agreementStartDate" value="{{ default_date }}" />
    </div>
    <div>
      <label>Include Non-Taking Advisers</label>
      <select id="includeNo">
        <option value="0" {% if not include_no %}selected{% endif %}>No</option>
        <option value="1" {% if include_no %}selected{% endif %}>Yes</option>
      </select>
    </div>
    <div>
      <button id="computeBtn" class="primary">Compute Availability</button>
    </div>
  </div>
  <div id="loading" style="display:none;margin-top:12px;color:var(--muted);">
    <span>üîÑ Computing adviser availability...</span>
  </div>
</div>

<table>
  <thead>
    <tr>
      <th>Adviser<div class="col-helper">Adviser full name</div></th>
      <th data-sort="num">Taking<br/>On Clients<div class="col-helper">Yes/No based on adviser availability</div></th>
      <th>Service<br/>Packages<div class="col-helper">Packages the adviser supports</div></th>
      <th>Pod<br/>Type<div class="col-helper">Solo vs full pod</div></th>
      <th>Household<br/>Type<div class="col-helper">Household types the adviser accepts</div></th>
      <th>Client<br/>Monthly Limit<div class="col-helper">Monthly target converted from fortnight plan</div></th>
      <th>Earliest<br/>Open Week<div class="col-helper">First week with available capacity</div></th>
      <th class="nowrap">Monday Date<div class="col-helper">Monday that anchors the open week</div></th>
    </tr>
  </thead>
  <tbody>
    {% if compute and rows %}
      {% for r in rows %}
        <tr>
          <td>{{ r.name }}</td>
          <td data-value="{{ r.taking_on_clients_sort }}">{{ r.taking_on_clients }}</td>
          <td>
            <div class="taglist">
              {% for t in r.tag_items %}
                <span class="tag {{ t.cls }}">{{ t.name }}</span>
              {% endfor %}
            </div>
          </td>
          <td>{{ r.pod }}</td>
          <td>
            <div class="taglist">
              {% for t in r.household_items %}
                <span class="tag {{ t.cls }}">{{ t.name }}</span>
              {% endfor %}
            </div>
          </td>
          <td>{{ r.limit }}</td>
          <td>{{ r.wk_label }}</td>
          <td class="nowrap">{{ r.monday }}</td>
        </tr>
      {% endfor %}
    {% elif compute and not rows %}
      <tr><td colspan="7">No advisers found matching criteria.</td></tr>
    {% else %}
      <tr><td colspan="7" style="text-align:center;color:var(--muted);padding:24px;">Click "Compute Availability" to see adviser availability data.</td></tr>
    {% endif %}
  </tbody>
</table>

{% endblock %}

{% block head %}
{{ super() }}
<style>
  .guide-card .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    margin-bottom: 12px;
  }

  .guide-card h3 {
    margin: 0;
  }

  .helper-toggle {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9em;
    color: var(--muted);
    cursor: pointer;
  }

  .helper-toggle input {
    margin: 0;
  }

  .inline-guide-title {
    font-weight: 600;
    margin: 0 0 6px 0;
  }

  .inline-guide {
    margin: 0 0 12px 0;
    padding-left: 1.2rem;
    font-size: 0.9em;
    color: var(--muted);
  }

  .inline-guide li {
    margin-bottom: 0.35rem;
  }

  .inline-guide li:last-child {
    margin-bottom: 0;
  }

  .col-helper {
    display: block;
    font-size: 0.75em;
    color: var(--muted);
    margin-top: 4px;
  }

  .helpers-hidden .inline-guide,
  .helpers-hidden .inline-guide-title,
  .helpers-hidden .col-helper {
    display: none !important;
  }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function() {
  // Table sorting functionality
  const table = document.querySelector('table');
  if (table) {
    const getCellValue = (td) => {
      const v = td.getAttribute('data-value');
      return v !== null ? Number(v) : td.textContent.trim().toLowerCase();
    };
    const comparer = (idx, numeric) => (a, b) => {
      const ta = a.children[idx];
      const tb = b.children[idx];
      const va = getCellValue(ta);
      const vb = getCellValue(tb);
      if (numeric) return (va === vb ? 0 : va > vb ? 1 : -1);
      return va.localeCompare(vb);
    };
    const ths = table.querySelectorAll('thead th');
    ths.forEach((th, idx) => {
      th.style.cursor = 'pointer';
      th.addEventListener('click', () => {
        const tbody = table.tBodies[0];
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const isNum = th.getAttribute('data-sort') === 'num';
        const asc = th.getAttribute('data-asc') !== 'true';
        rows.sort(comparer(idx, isNum));
        if (!asc) rows.reverse();
        rows.forEach(r => tbody.appendChild(r));
        ths.forEach(h => h.removeAttribute('data-asc'));
        th.setAttribute('data-asc', asc ? 'true' : 'false');
      });
    });
  }

  // Compute button functionality
  const computeBtn = document.getElementById('computeBtn');
  const agreementDateInput = document.getElementById('agreementStartDate');
  const includeNoSelect = document.getElementById('includeNo');
  const loadingDiv = document.getElementById('loading');

  if (includeNoSelect && !includeNoSelect.value) {
    includeNoSelect.value = '0';
  }

  if (computeBtn && agreementDateInput && includeNoSelect) {
    computeBtn.addEventListener('click', function() {
      const agreementDate = agreementDateInput.value;
      const includeNo = includeNoSelect.value;
      
      if (!agreementDate) {
        alert('Please select an agreement start date');
        return;
      }

      // Show loading state
      loadingDiv.style.display = 'block';
      computeBtn.disabled = true;
      computeBtn.textContent = 'Computing...';

      // Build URL with parameters
      const params = new URLSearchParams({
        compute: '1',
        agreement_start_date: agreementDate,
        include_no: includeNo || '0'
      });

      // Redirect to same page with compute parameters
      window.location.href = '?' + params.toString();
    });
  }

  const helperToggle = document.getElementById('toggleHelpers');
  if (helperToggle) {
    const applyHelperState = () => {
      document.body.classList.toggle('helpers-hidden', !helperToggle.checked);
    };
    helperToggle.addEventListener('change', applyHelperState);
    applyHelperState();
  }
})();
</script>
{% endblock %}
