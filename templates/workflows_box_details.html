{% extends 'layout.html' %}
{% set title = 'Box Workflow Details' %}

{% block content %}
<div class="topbar">
  <div style="display:flex;align-items:center;gap:16px;">
    <a href="/workflows" style="color:#d0d7e2;text-decoration:none;font-size:0.9em;">← Back to Workflows</a>
    <h2>Box Folder Workflow Guide</h2>
  </div>
  <div class="datebox">
    <span>Today: {{ today }}</span>
    <span>Version: {{ app_version or 'n/a' }}</span>
  </div>
</div>

<div class="card">
  <h3>Workflow Overview</h3>
  <ol>
    <li><strong>Create folder</strong> via <code>POST /box/folder/create</code> using the deal and contact names.</li>
    <li><strong>Tag metadata</strong> with <code>POST /box/folder/tag</code> once you have the new <code>folder_id</code>.</li>
    <li><strong>Share Client Sharing</strong> subfolder through <code>POST /box/folder/share</code> (optional until automation is enabled).</li>
  </ol>
  <p class="muted">Each HubSpot custom-code action receives the same payload shape. You can reuse the dictionary of HubSpot fields across all three calls—include spouse identifiers, names, and email when they exist, but the workflow now tolerates households without a spouse.</p>
</div>

<div class="card">
  <h3>Folder Naming Rules</h3>
  <ul>
    <li>Single contact → <code>First Last</code> (e.g. <em>Alex Taylor</em>).</li>
    <li>Two contacts with the same surname → <code>First &amp; PartnerFirst Last</code> (e.g. <em>Alex &amp; Sam Taylor</em>).</li>
    <li>Two contacts with different surnames → <code>First Last &amp; PartnerFirst PartnerLast</code> (e.g. <em>Priya Patel &amp; Chris Williams</em>).</li>
    <li>Primary + spouse only — additional associated contacts do not appear in the folder name.</li>
    <li>If no contact names are available, the system falls back to <code>Deal {deal_id}</code>.</li>
  </ul>
  <p class="muted">Names come directly from the associated HubSpot contacts included in the deal payload—provide them in the order you want them to appear.</p>
</div>

<div class="card">
  <h3>Endpoint Input Reference</h3>
  <table class="input-table">
    <thead>
      <tr>
        <th>Endpoint</th>
        <th>Minimum fields</th>
        <th>Notes</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>/box/folder/create</code></td>
        <td><code>hs_deal_record_id</code>, primary first/last, <code>deal_salutation</code></td>
        <td>Spouse names optional—the service will create folders for single-client households. Folder name now derives from the primary/partner names (e.g. <code>Alex &amp; Sam Taylor</code>).</td>
      </tr>
      <tr>
        <td><code>/box/folder/tag</code></td>
        <td><code>folder_id</code>, contact ID/name/email, <code>deal_salutation</code>, <code>household_type</code></td>
        <td>Spouse metadata is optional—provide it when available to enrich the template.</td>
      </tr>
      <tr>
        <td><code>/box/folder/share</code></td>
        <td><code>folder_id</code>, <code>hs_contact_email</code></td>
        <td>Spouse email optional—the endpoint shares with every email you supply.</td>
      </tr>
    </tbody>
  </table>
</div>

<div class="card">
  <h3>HubSpot Custom Code Actions</h3>
  <p class="muted">Set up three custom-code actions in your workflow—one for each Box endpoint. Reuse the field lists shown below and pass the <code>folder_id</code> output from Action 1 into Actions 2 and 3.</p>

  <h4 id="action-create">Action 1 – POST /box/folder/create</h4>
  <div class="field-chips">
    <span class="chip-required">hs_deal_record_id</span>
    <span class="chip-required">hs_contact_firstname</span>
    <span class="chip-required">hs_contact_lastname</span>
    <span class="chip-required">deal_salutation</span>
    <span class="chip-optional">hs_spouse_firstname</span>
    <span class="chip-optional">hs_spouse_lastname</span>
  </div>
  <p class="field-note">Provide spouse first/last name when available; otherwise the folder falls back to the primary contact details.</p>
  <pre class="code-block"><code>import requests

BOX_BASE = &quot;https://&lt;your-app-domain&gt;&quot;

def main(event):
    fields = {**(event.get(&quot;fields&quot;) or {}), **(event.get(&quot;inputFields&quot;) or {})}
    deal_id = event.get(&quot;deal_id&quot;) or fields[&quot;hs_deal_record_id&quot;]

    payload_fields = {
        &quot;hs_deal_record_id&quot;: str(deal_id),
        &quot;hs_contact_firstname&quot;: str(fields[&quot;hs_contact_firstname&quot;]),
        &quot;hs_contact_lastname&quot;: str(fields[&quot;hs_contact_lastname&quot;]),
        &quot;deal_salutation&quot;: str(fields[&quot;deal_salutation&quot;]),
    }
    for key in (&quot;hs_spouse_firstname&quot;, &quot;hs_spouse_lastname&quot;):
        value = fields.get(key)
        if value:
            payload_fields[key] = str(value)

    payload = {
        &quot;deal_id&quot;: str(deal_id),
        &quot;fields&quot;: payload_fields,
    }

    resp = requests.post(
        f&quot;{BOX_BASE}/box/folder/create&quot;,
        json=payload,
        timeout=20,
    )
    resp.raise_for_status()
    folder = resp.json().get(&quot;folder&quot;, {})

    return {
        &quot;outputFields&quot;: {
            &quot;folder_id&quot;: folder.get(&quot;id&quot;),
            &quot;folder_url&quot;: folder.get(&quot;url&quot;),
            &quot;folder_name&quot;: folder.get(&quot;name&quot;),
        }
    }</code></pre>

  <h4 id="action-tag">Action 2 – POST /box/folder/tag</h4>
  <div class="field-chips">
    <span class="chip-required">hs_deal_record_id</span>
    <span class="chip-required">folder_id</span>
    <span class="chip-required">hs_contact_id</span>
    <span class="chip-required">hs_contact_email</span>
    <span class="chip-required">hs_contact_firstname</span>
    <span class="chip-required">hs_contact_lastname</span>
    <span class="chip-required">deal_salutation</span>
    <span class="chip-required">household_type</span>
    <span class="chip-optional">hs_spouse_id</span>
    <span class="chip-optional">hs_spouse_email</span>
    <span class="chip-optional">hs_spouse_firstname</span>
    <span class="chip-optional">hs_spouse_lastname</span>
  </div>
  <p class="field-note"><code>folder_id</code> comes from Action 1; include spouse metadata when it exists to keep tagging self-contained.</p>
  <pre class="code-block"><code>import requests

BOX_BASE = &quot;https://&lt;your-app-domain&gt;&quot;

def main(event):
    fields = {**(event.get(&quot;fields&quot;) or {}), **(event.get(&quot;inputFields&quot;) or {})}
    deal_id = event.get(&quot;deal_id&quot;) or fields[&quot;hs_deal_record_id&quot;]
    folder_id = event.get(&quot;folder_id&quot;) or fields[&quot;folder_id&quot;]

    metadata_fields = {
        &quot;hs_deal_record_id&quot;: str(deal_id),
        &quot;hs_contact_id&quot;: str(fields[&quot;hs_contact_id&quot;]),
        &quot;hs_contact_email&quot;: str(fields[&quot;hs_contact_email&quot;]),
        &quot;hs_contact_firstname&quot;: str(fields[&quot;hs_contact_firstname&quot;]),
        &quot;hs_contact_lastname&quot;: str(fields[&quot;hs_contact_lastname&quot;]),
        &quot;deal_salutation&quot;: str(fields[&quot;deal_salutation&quot;]),
        &quot;household_type&quot;: str(fields[&quot;household_type&quot;]),
    }
    for key in (
        &quot;hs_spouse_id&quot;,
        &quot;hs_spouse_email&quot;,
        &quot;hs_spouse_firstname&quot;,
        &quot;hs_spouse_lastname&quot;,
    ):
        value = fields.get(key)
        if value:
            metadata_fields[key] = str(value)

    payload = {
        &quot;deal_id&quot;: str(deal_id),
        &quot;folder_id&quot;: str(folder_id),
        &quot;fields&quot;: metadata_fields,
    }

    resp = requests.post(
        f&quot;{BOX_BASE}/box/folder/tag&quot;,
        json=payload,
        timeout=20,
    )
    resp.raise_for_status()

    return {
        &quot;outputFields&quot;: {
            &quot;folder_id&quot;: str(folder_id),
            &quot;metadata_status&quot;: &quot;applied&quot;,
        }
    }</code></pre>

  <h4 id="action-share">Action 3 – POST /box/folder/share</h4>
  <div class="field-chips">
    <span class="chip-required">folder_id</span>
    <span class="chip-required">hs_contact_email</span>
    <span class="chip-optional">hs_spouse_email</span>
  </div>
  <p class="field-note">Share with as many emails as you provide—add the spouse address only when one exists.</p>
  <pre class="code-block"><code>import requests

BOX_BASE = &quot;https://&lt;your-app-domain&gt;&quot;

def main(event):
    fields = {**(event.get(&quot;fields&quot;) or {}), **(event.get(&quot;inputFields&quot;) or {})}
    folder_id = event.get(&quot;folder_id&quot;) or fields[&quot;folder_id&quot;]
    emails = [
        value
        for value in (
            fields.get(&quot;hs_contact_email&quot;),
            fields.get(&quot;hs_spouse_email&quot;),
        )
        if value
    ]

    payload = {
        &quot;folder_id&quot;: str(folder_id),
        &quot;emails&quot;: emails,
    }
    if fields.get(&quot;hs_contact_email&quot;):
        payload[&quot;hs_contact_email&quot;] = str(fields[&quot;hs_contact_email&quot;])
    if fields.get(&quot;hs_spouse_email&quot;):
        payload[&quot;hs_spouse_email&quot;] = str(fields[&quot;hs_spouse_email&quot;])

    resp = requests.post(
        f&quot;{BOX_BASE}/box/folder/share&quot;,
        json=payload,
        timeout=20,
    )
    resp.raise_for_status()

    return {
        &quot;outputFields&quot;: {
            &quot;folder_id&quot;: str(folder_id),
            &quot;shared_emails&quot;: emails,
        }
    }</code></pre>
  <h4 id="action-auto">Optional Auto Tag – POST /box/folder/tag/auto</h4>
  <p class="field-note">Use the auto-tag endpoint when the workflow payload might miss a metadata field. Provide the deal and folder identifiers plus whatever contact fields you have—any missing metadata is fetched directly from HubSpot before applying the template.</p>
  <p class="muted small">Because this endpoint handles the fallback logic internally, you can reuse the Action&nbsp;2 payload as-is and swap the URL to <code>/box/folder/tag/auto</code> when operating in a workflow that cannot guarantee every HubSpot property.</p>
</div>

<div class="card">
  <h3>Required HubSpot Properties</h3>
  <ul>
    <li><code>hs_deal_record_id</code></li>
    <li><code>hs_contact_id</code>, <code>hs_contact_email</code>, first/last name</li>
    <li>Spouse fields (<code>hs_spouse_id</code>, <code>hs_spouse_email</code>, first/last name) <em>(optional)</em></li>
    <li><code>deal_salutation</code>, <code>household_type</code></li>
  </ul>
  <div class="actions">
    <a class="secondary" href="{{ url_for('serve_docs', filename='box-folder-workflow.md') }}" target="_blank">
      Open full workflow reference →
    </a>
  </div>
</div>

<div class="card" id="diagnostics-overview">
  <h3>Diagnostics &amp; Support Tools</h3>
  <p class="muted">Use the helper endpoints below to verify access, inspect collaborator lists, or identify folders still missing metadata.</p>

  <h4 id="diagnostics-subfolders">Subfolder Inventory</h4>
  <p class="muted small">Call <code>GET /box/folder/subfolders</code> with a <code>folder_id</code> to list every immediate child. Handy when validating the Client Sharing subfolder exists after creation.</p>

  <h4 id="diagnostics-collaborators">Collaborator Lookup</h4>
  <p class="muted small">Use <code>GET /box/folder/collaborators</code> in the UI or via API to flag non-Pivot collaborators. Pair it with <code>GET /box/collaborators/contact</code> to pull HubSpot context for any email.</p>

  <h4 id="diagnostics-metadata">Missing Metadata Scan</h4>
  <p class="muted small"><code>GET /_public/box/folder/missing-metadata</code> returns up to five active client folders still waiting on metadata. Review the issues array in the response to spot folders the automation could not inspect.</p>
  <div class="actions" style="margin-top:12px;">
    <a class="secondary" href="/box/folder/metadata/status">
      Open metadata snapshot →
    </a>
  </div>
</div>
{% endblock %}

{% block head %}
{{ super() }}
  <style>
  .field-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin: 8px 0 12px;
  }
  .field-chips span {
    background: rgba(15, 23, 42, 0.08);
    border-radius: 14px;
    padding: 4px 10px;
    font-size: 0.85em;
    letter-spacing: 0.01em;
  }
  .field-chips .chip-required {
    background: rgba(79, 70, 229, 0.18);
    border: 1px solid rgba(79, 70, 229, 0.35);
    font-weight: 600;
  }
  .field-chips .chip-optional {
    background: rgba(148, 163, 184, 0.18);
    border: 1px dashed rgba(148, 163, 184, 0.55);
    color: #475569;
  }
  .field-note {
    margin: 4px 0 12px;
    font-size: 0.85em;
    color: #52606d;
  }
  .code-block {
    background: #1e1e1e;
    color: #e8e8e8;
    padding: 16px;
    border-radius: 12px;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .input-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
  }
  .input-table th,
  .input-table td {
    border: 1px solid #d9e2ef;
    padding: 8px 10px;
    text-align: left;
    vertical-align: top;
  }
  .input-table th {
    background: rgba(15, 23, 42, 0.06);
    font-weight: 600;
  }
  .actions {
    margin-top: 12px;
  }
  .actions a {
    text-decoration: none;
  }
</style>
{% endblock %}
