{% extends "layout.html" %}
{% set title = "Box Collaborator Lookup" %}

{% block content %}
<div class="topbar">
  <div style="display:flex;align-items:center;gap:16px;">
    <a href="/" style="color:#d0d7e2;text-decoration:none;font-size:0.9em;">‚Üê Home</a>
    <h2>Box Collaborator Lookup</h2>
  </div>
  <div class="datebox">
    <span>Status:</span>
    <span id="status-text" class="muted">Awaiting folder id</span>
  </div>
</div>

<div class="card lookup-card">
  <p class="muted small">
    Enter a Box <code>folder_id</code>, optionally inspect subfolders, and review collaborator access.
    External emails (outside <code>@pivotwealth.com.au</code>) are highlighted.
  </p>
  <form id="collab-form" class="collab-form">
    <label class="field">
      <span>Folder ID</span>
      <input type="text" id="folder-id" autocomplete="off" required />
    </label>
    <div class="actions root-actions">
      <button type="button" class="secondary" id="load-subfolders">Display Subfolders</button>
      <button type="button" class="primary" id="root-show" data-default="Show Collaborators">Show Collaborators</button>
      <button type="button" class="secondary" id="reset-btn">Cancel</button>
    </div>
    <div id="subfolder-wrapper" class="subfolder-wrapper hidden">
      <h3>Subfolders</h3>
      <p class="muted small" id="subfolder-empty">No subfolders loaded.</p>
      <div id="subfolder-list" class="subfolder-list hidden"></div>
      <div id="subfolder-actions" class="subfolder-actions hidden">
        <button type="button" class="primary" id="subfolder-show" data-default="Show Collaborators">Show Collaborators</button>
      </div>
    </div>
  </form>
</div>

<div id="external-card" class="card hidden">
  <h3>External Emails</h3>
  <p class="muted small" id="external-empty">No external collaborators detected.</p>
  <ul id="external-list" class="external-list hidden"></ul>
</div>

<div id="results-wrapper" class="card hidden">
  <h3>Collaborators</h3>
  <p class="muted small" id="summary-target"></p>
  <p><strong>Total collaborators:</strong> <span id="collab-total">0</span></p>
  <p><strong>External collaborators:</strong> <span id="external-total">0</span></p>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Email</th>
          <th>Name</th>
          <th>Role</th>
          <th>Status</th>
          <th>HubSpot</th>
        </tr>
      </thead>
      <tbody id="collab-table-body">
        <tr><td colspan="5" class="muted">No results yet.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div id="deal-card" class="card hidden">
  <div class="deal-header">
    <h3>Associated Deals</h3>
    <select id="deal-select" class="deal-select"></select>
  </div>
  <p class="muted small" id="deal-message">Select a deal to load metadata values.</p>
</div>

<div id="contact-card" class="card hidden">
  <h3>HubSpot Contact Details</h3>
  <div id="contact-details" class="contact-details muted small">
    Select a collaborator to load HubSpot details.
  </div>
  <div id="metadata-actions" class="contact-actions hidden">
    <button type="button" class="primary" id="metadata-create-btn" data-default="Create Box Metadata">
      Create Box Metadata
    </button>
    <p id="metadata-status" class="muted small"></p>
    <div id="metadata-preview" class="metadata-preview hidden">
      <h4 class="muted small">Metadata preview</h4>
      <pre id="metadata-preview-content"></pre>
    </div>
  </div>
</div>

<div id="error-card" class="card error-card hidden"></div>

<div class="floating-note">
  <strong>Quick tip</strong>
  <span>Need API payloads? Visit the workflow documentation for request examples.</span>
</div>
{% endblock %}

{% block head %}
<style>
  .lookup-card {
    margin-bottom: 20px;
  }

  .collab-form {
    display: grid;
    gap: 12px;
    max-width: 420px;
  }

  .field {
    display: flex;
    flex-direction: column;
    gap: 6px;
    font-weight: 600;
  }

  .field span {
    font-size: 0.85em;
    color: #5a6578;
    font-weight: 500;
  }

  .actions,
  .subfolder-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .subfolder-wrapper {
    border: 1px solid rgba(148, 163, 184, 0.35);
    border-radius: 12px;
    padding: 14px;
    background: rgba(15, 23, 42, 0.02);
    display: grid;
    gap: 10px;
  }

  .subfolder-list {
    display: grid;
    gap: 6px;
  }

  .subfolder-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    border: 1px solid rgba(148, 163, 184, 0.35);
    border-radius: 10px;
    background: rgba(15, 23, 42, 0.015);
  }

  .subfolder-item span {
    font-size: 0.85em;
    color: #52606d;
  }

  .table-wrapper {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  th,
  td {
    text-align: left;
    padding: 8px 10px;
    border-bottom: 1px solid rgba(148, 163, 184, 0.35);
    font-size: 0.9em;
  }

  tr.external td {
    background: rgba(239, 68, 68, 0.12);
    color: #7f1d1d;
    font-weight: 600;
  }

  .external-list {
    list-style: disc;
    padding-left: 20px;
    display: grid;
    gap: 6px;
  }

  .deal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }

  .deal-select {
    min-width: 220px;
    padding: 6px 8px;
  }

  .pivot-toggle {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85em;
    color: #52606d;
    margin-bottom: 12px;
  }

  .contact-details {
    display: grid;
    gap: 10px;
  }

  .contact-details table {
    width: 100%;
    border-collapse: collapse;
  }

  .contact-details th,
  .contact-details td {
    text-align: left;
    padding: 6px 8px;
    border-bottom: 1px solid rgba(148, 163, 184, 0.35);
  }

  .contact-actions {
    margin-top: 12px;
    display: grid;
    gap: 6px;
  }

  .contact-actions button {
    width: fit-content;
  }

  .metadata-preview {
    border: 1px solid rgba(148, 163, 184, 0.35);
    border-radius: 10px;
    padding: 10px;
    background: rgba(15, 23, 42, 0.02);
    max-width: 420px;
  }

  .metadata-preview pre {
    margin: 6px 0 0 0;
    font-size: 0.82em;
    max-height: 220px;
    overflow: auto;
  }

  .hubspot-btn {
    font-size: 0.8em;
    padding: 4px 10px;
  }

  .error-card {
    border: 1px solid rgba(239, 68, 68, 0.35);
    color: #991b1b;
    background: rgba(239, 68, 68, 0.1);
    margin-top: 16px;
  }

  .floating-note {
    position: fixed;
    right: 24px;
    bottom: 24px;
    background: rgba(17, 24, 39, 0.9);
    color: #f8fafc;
    padding: 12px 18px;
    border-radius: 12px;
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.3);
    max-width: 260px;
    font-size: 0.88em;
    line-height: 1.4;
    z-index: 40;
  }

  .floating-note strong {
    display: block;
    margin-bottom: 4px;
    font-size: 0.95em;
  }

  @media (max-width: 720px) {
    .floating-note {
      left: 16px;
      right: 16px;
      bottom: 16px;
    }
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  const folderInput = document.getElementById('folder-id');
  const loadSubfoldersButton = document.getElementById('load-subfolders');
  const rootShowButton = document.getElementById('root-show');
  const resetButton = document.getElementById('reset-btn');
  const subfolderWrapper = document.getElementById('subfolder-wrapper');
  const subfolderList = document.getElementById('subfolder-list');
  const subfolderEmpty = document.getElementById('subfolder-empty');
  const subfolderActions = document.getElementById('subfolder-actions');
  const subfolderShowButton = document.getElementById('subfolder-show');

  const statusText = document.getElementById('status-text');
  const resultsWrapper = document.getElementById('results-wrapper');
  const collabTotal = document.getElementById('collab-total');
  const externalTotal = document.getElementById('external-total');
  const summaryTarget = document.getElementById('summary-target');
  const collabTableBody = document.getElementById('collab-table-body');
  const externalCard = document.getElementById('external-card');
  const externalList = document.getElementById('external-list');
  const externalEmpty = document.getElementById('external-empty');
  const dealCard = document.getElementById('deal-card');
  const dealSelect = document.getElementById('deal-select');
  const dealMessage = document.getElementById('deal-message');
  const errorCard = document.getElementById('error-card');
  const contactCard = document.getElementById('contact-card');
  const contactDetails = document.getElementById('contact-details');
  const metadataActions = document.getElementById('metadata-actions');
  const metadataButton = document.getElementById('metadata-create-btn');
  const metadataStatus = document.getElementById('metadata-status');
  const metadataPreview = document.getElementById('metadata-preview');
  const metadataPreviewContent = document.getElementById('metadata-preview-content');

  let selectedSubfolderId = null;
  let selectedSubfolderName = null;
  let currentFolderId = '';
  let lastCollabResponse = null;
  let lastContactData = null;
  let rootFolderId = '';
  let currentDealList = [];
  let currentSelectedDeal = null;

  function setBusy(button, busy, label) {
    if (!button) return;
    if (busy) {
      button.dataset.default = button.dataset.default || button.textContent;
      button.textContent = label;
      button.disabled = true;
    } else {
      button.textContent = button.dataset.default || 'Submit';
      button.disabled = false;
    }
  }

  function resetUI() {
    resultsWrapper.classList.add('hidden');
    externalCard.classList.add('hidden');
    errorCard.classList.add('hidden');
    contactCard.classList.add('hidden');
    if (metadataActions) {
      metadataActions.classList.add('hidden');
    }
    if (metadataPreview) {
      metadataPreview.classList.add('hidden');
    }
    if (metadataPreviewContent) {
      metadataPreviewContent.textContent = '';
    }
    contactDetails.textContent = 'Select a collaborator to load HubSpot details.';
    collabTableBody.innerHTML = '<tr><td colspan="5" class="muted">No results yet.</td></tr>';
    externalList.innerHTML = '';
    externalList.classList.add('hidden');
    externalEmpty.classList.remove('hidden');
    if (dealSelect) dealSelect.innerHTML = '';
    if (dealMessage) dealMessage.textContent = 'Select a deal to load metadata values.';
    if (dealCard) dealCard.classList.add('hidden');
    collabTotal.textContent = '0';
    externalTotal.textContent = '0';
    statusText.textContent = 'Awaiting folder id';
    summaryTarget.textContent = '';
    subfolderList.innerHTML = '';
    subfolderList.classList.add('hidden');
    subfolderEmpty.classList.remove('hidden');
    subfolderWrapper.classList.add('hidden');
    subfolderActions.classList.add('hidden');
    selectedSubfolderId = null;
    selectedSubfolderName = null;
    currentFolderId = '';
    lastCollabResponse = null;
    lastContactData = null;
    currentDealList = [];
    currentSelectedDeal = null;
    rootFolderId = '';
    if (metadataStatus) {
      metadataStatus.textContent = '';
    }
  }

  async function fetchJSON(url, options) {
    let resp;
    try {
      resp = await fetch(url, options);
    } catch (networkError) {
      const error = new Error('Network error while contacting the server');
      error.detail = { network: true, original: String(networkError) };
      throw error;
    }

    const contentType = resp.headers.get('content-type') || '';
    let rawText = '';
    try {
      rawText = await resp.text();
    } catch (bodyError) {
      const error = new Error('Failed to read response body');
      error.detail = { original: String(bodyError) };
      error.status = resp.status;
      throw error;
    }

    let data = null;
    if (contentType.includes('application/json') && rawText) {
      try {
        data = JSON.parse(rawText);
      } catch (parseError) {
        const error = new Error('Invalid JSON response received');
        error.detail = { raw: rawText };
        error.status = resp.status;
        throw error;
      }
    }

    if (!resp.ok) {
      const error = new Error(data?.message || 'Request failed');
      error.detail = data || (rawText ? { raw: rawText } : {});
      error.status = resp.status;
      throw error;
    }

    if (data !== null) {
      return data;
    }
    return rawText ? { raw: rawText } : {};
  }

  async function fetchContactDetails(email) {
    const trimmed = (email || '').trim();
    if (!trimmed) {
      return null;
    }
    const url = new URL('/box/collaborators/contact', window.location.origin);
    url.searchParams.set('email', trimmed);
    try {
      return await fetchJSON(url);
    } catch (error) {
      if (error.status === 404) {
        return null;
      }
      throw error;
    }
  }

  function normalizeFolderId(raw) {
    const value = (raw || '').trim();
    if (!value) return '';
    const urlMatch = value.match(/(?:folder=|folders\/|folder\/)(\d{5,})/i);
    if (urlMatch) {
      return urlMatch[1];
    }
    const idMatch = value.match(/(\d{5,})/);
    return idMatch ? idMatch[1] : value;
  }

  async function loadSubfolders() {
    const rawFolderValue = folderInput.value.trim();
    const folderId = normalizeFolderId(rawFolderValue);
    if (!folderId) {
      statusText.textContent = 'Validation error ¬∑ folder id required';
      return;
    }

    if (folderId !== rawFolderValue) {
      folderInput.value = folderId;
    }

    setBusy(loadSubfoldersButton, true, 'Loading‚Ä¶');
    errorCard.classList.add('hidden');

    try {
      const url = new URL('/box/folder/subfolders', window.location.origin);
      url.searchParams.set('folder_id', folderId);
      const data = await fetchJSON(url);
      currentFolderId = folderId;
      rootFolderId = folderId;
      renderSubfolders(data.subfolders || [], folderId);
      statusText.textContent = (data.subfolders || []).length
        ? 'Select a subfolder then choose Show Collaborators.'
        : 'No subfolders found for this folder.';
    } catch (error) {
      showError(error);
    } finally {
      setBusy(loadSubfoldersButton, false);
    }
  }

  function renderSubfolders(subfolders, folderId, activeSubfolderId) {
    subfolderWrapper.classList.remove('hidden');
    subfolderList.innerHTML = '';
    currentFolderId = folderId;

    const targetSubfolderId = activeSubfolderId || selectedSubfolderId || null;
    selectedSubfolderId = null;
    selectedSubfolderName = null;

    if (Array.isArray(subfolders) && subfolders.length) {
      subfolderActions.classList.remove('hidden');
      subfolders.forEach((child) => {
        const item = document.createElement('label');
        item.className = 'subfolder-item';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = child.id;
        checkbox.dataset.name = child.name;
        checkbox.addEventListener('change', () => {
          if (!checkbox.checked) {
            selectedSubfolderId = null;
            selectedSubfolderName = null;
            return;
          }
          subfolderList.querySelectorAll('input[type="checkbox"]').forEach((cb) => {
            if (cb !== checkbox) cb.checked = false;
          });
          selectedSubfolderId = child.id;
          selectedSubfolderName = child.name;
          currentFolderId = folderId;
        });
        const text = document.createElement('span');
        text.innerHTML = `<strong>${child.name || 'Untitled'}</strong> <small class="muted">(#${child.id})</small>`;
        item.appendChild(checkbox);
        item.appendChild(text);
        subfolderList.appendChild(item);

        if (targetSubfolderId && targetSubfolderId === String(child.id)) {
          checkbox.checked = true;
          selectedSubfolderId = String(child.id);
          selectedSubfolderName = child.name || null;
          statusText.textContent = `Selected subfolder ${selectedSubfolderName || selectedSubfolderId}`;
        }
      });
      subfolderList.classList.remove('hidden');
      subfolderEmpty.classList.add('hidden');
    } else {
      subfolderList.classList.add('hidden');
      subfolderEmpty.classList.remove('hidden');
      subfolderActions.classList.add('hidden');
    }
  }

  async function showCollaborators(button, folderId, subfolderId, subfolderName) {
    const normalizedFolderId = normalizeFolderId(folderId);
    if (normalizedFolderId !== folderId) {
      folderId = normalizedFolderId;
      folderInput.value = folderId;
    }

    if (!folderId) {
      statusText.textContent = 'Validation error ¬∑ folder id required';
      return;
    }

    if (!subfolderId) {
      rootFolderId = folderId;
    }

    setBusy(button, true, 'Loading‚Ä¶');
    errorCard.classList.add('hidden');

    try {
      const url = new URL('/box/folder/collaborators', window.location.origin);
      url.searchParams.set('folder_id', folderId);
      if (subfolderId) {
        url.searchParams.set('subfolder_id', subfolderId);
        if (subfolderName) {
          url.searchParams.set('subfolder', subfolderName);
        }
      }
      const data = await fetchJSON(url);
      currentFolderId = folderId;
      if (!rootFolderId) {
        rootFolderId = folderId;
      }
      renderCollaborators(data);
      rootFolderId = data.folder_id || rootFolderId || folderId;
      statusText.textContent = `Success ¬∑ ${data.total} collaborators found`;
    } catch (error) {
      showError(error);
    } finally {
      setBusy(button, false);
    }
  }

  function renderCollaborators(data) {
    lastCollabResponse = data || null;
    lastContactData = null;
    contactCard.classList.add('hidden');
    contactDetails.textContent = 'Select a collaborator to load HubSpot details.';
    if (metadataActions) {
      metadataActions.classList.add('hidden');
      metadataStatus.textContent = '';
      metadataButton.disabled = false;
    }
    if (metadataPreview) {
      metadataPreview.classList.add('hidden');
    }
    if (metadataPreviewContent) {
      metadataPreviewContent.textContent = '';
    }
    if (dealSelect) dealSelect.innerHTML = '';
    if (dealMessage) dealMessage.textContent = 'Select a deal to load metadata values.';
    if (dealCard) dealCard.classList.add('hidden');
    currentDealList = [];
    currentSelectedDeal = null;

    const pivotDomain = '@pivotwealth.com.au';
    const collaborators = Array.isArray(data.collaborators) ? data.collaborators : [];
    const external = (data.external && Array.isArray(data.external))
      ? data.external
      : collaborators.filter(
          (collab) => collab.email && !collab.email.endsWith(pivotDomain)
        );
    collabTotal.textContent = collaborators.length;
    const externalCount = external.length;
    externalTotal.textContent = externalCount;

    let summaryText;
    if (data.inspected && data.inspected.id) {
      const inspectedName = data.inspected.name || 'Folder';
      summaryText = `Inspecting ${inspectedName} (id ${data.inspected.id})`;
    } else {
      summaryText = `Inspecting folder ${data.target_folder_id}`;
    }
    summaryTarget.textContent = `${summaryText} ¬∑ ${externalCount} external collaborators highlighted`;

    collabTableBody.innerHTML = '';
    if (!external.length) {
      collabTableBody.innerHTML = '<tr><td colspan="5" class="muted">No external collaborators found.</td></tr>';
    } else {
      external.forEach((collab) => {
        const tr = document.createElement('tr');
        const email = collab.email || '‚Äî';
        tr.classList.add('external');
        tr.dataset.isExternal = '1';

        tr.innerHTML = `
          <td>${email}</td>
          <td>${collab.name || '‚Äî'}</td>
          <td>${collab.role || '‚Äî'}</td>
          <td>${collab.status || '‚Äî'}</td>
          <td><button type="button" class="secondary hubspot-btn" data-email="${email}">HubSpot Details</button></td>
        `;
        collabTableBody.appendChild(tr);
      });
    }

    if (externalCount) {
      externalList.innerHTML = '';
      external.forEach((collab) => {
        const li = document.createElement('li');
        li.textContent = `${collab.email} (${collab.name || 'no name'})`;
        externalList.appendChild(li);
      });
      externalCard.classList.remove('hidden');
      externalList.classList.remove('hidden');
      externalEmpty.classList.add('hidden');
    } else {
      externalCard.classList.add('hidden');
      externalList.classList.add('hidden');
      externalEmpty.classList.remove('hidden');
      externalEmpty.textContent = 'No external collaborators detected.';
    }

    contactCard.classList.add('hidden');
    contactDetails.textContent = 'Select a collaborator to load HubSpot details.';
    resultsWrapper.classList.remove('hidden');
  }

  function renderContactDetails(data) {
    if (!data || !data.contact) {
      lastContactData = null;
      contactDetails.textContent = 'No HubSpot details found.';
      contactCard.classList.remove('hidden');
      if (metadataActions) {
        metadataActions.classList.add('hidden');
        metadataStatus.textContent = 'Metadata creation requires contact and deal context.';
      }
      if (metadataPreview) {
        metadataPreview.classList.add('hidden');
      }
      if (metadataPreviewContent) {
        metadataPreviewContent.textContent = '';
      }
      return;
    }

    lastContactData = data;
    const contact = data.contact;
    const props = contact.properties || {};
    const deals = data.deals || [];

    let html = '<table><tbody>';
    html += `<tr><th>ID</th><td>${contact.id || '‚Äî'}</td></tr>`;
    html += `<tr><th>Name</th><td>${props.firstname || ''} ${props.lastname || ''}</td></tr>`;
    html += `<tr><th>Email</th><td>${props.email || '‚Äî'}</td></tr>`;
    html += `<tr><th>Phone</th><td>${props.phone || '‚Äî'}</td></tr>`;
    if (contact.url) {
      html += `<tr><th>HubSpot</th><td><a href="${contact.url}" target="_blank" rel="noopener">Open Contact</a></td></tr>`;
    }
    html += '</tbody></table>';

    if (deals.length) {
      html += '<div class="deals"><h4>Associated Deals</h4><ul>';
      deals.forEach((deal) => {
        const dealProps = deal.properties || {};
        const name = dealProps.dealname || `Deal ${deal.id}`;
        const stage = dealProps.dealstage || 'Unknown stage';
        const amount = dealProps.amount ? `$${dealProps.amount}` : '‚Äî';
        const link = deal.url ? `<a href="${deal.url}" target="_blank" rel="noopener">Open</a>` : '';
        html += `<li><strong>${name}</strong> ¬∑ Stage: ${stage} ¬∑ Amount: ${amount} ${link}</li>`;
      });
      html += '</ul></div>';
    } else {
      html += '<p class="muted small">No associated deals found.</p>';
    }

    contactDetails.innerHTML = html;
  contactCard.classList.remove('hidden');
    if (metadataActions) {
      metadataActions.classList.remove('hidden');
      metadataStatus.textContent = deals.length
        ? 'Select a deal from the dropdown below before applying metadata.'
        : 'No associated deals found. You will be prompted for details before applying.';
      metadataButton.disabled = false;
    }
  if (metadataPreview) {
    metadataPreview.classList.add('hidden');
  }
  if (metadataPreviewContent) {
    metadataPreviewContent.textContent = '';
  }
  populateDealDropdown(deals);
}

  async function createMetadata() {
    if (!metadataButton) {
      return;
    }

    const folderValue = rootFolderId
      || (lastCollabResponse && lastCollabResponse.inspected && lastCollabResponse.inspected.id)
      || currentFolderId
      || folderInput.value.trim();
    const folderId = normalizeFolderId(folderValue);
    if (!folderId) {
      metadataStatus.textContent = 'Folder id is unavailable. Load collaborators first.';
      return;
    }
    if (folderId !== folderValue) {
      folderInput.value = folderId;
    }

    let selectedDeal = currentSelectedDeal;
    let dealId = '';
    if (!selectedDeal) {
      const manual = window.prompt('Enter HubSpot deal id for metadata tagging');
      if (manual === null) {
        metadataStatus.textContent = 'Metadata creation cancelled.';
        return;
      }
      dealId = (manual || '').trim();
      if (!dealId) {
        metadataStatus.textContent = 'Deal id is required to apply metadata.';
        return;
      }
      if (metadataStatus) {
        metadataStatus.textContent = 'Using manually supplied deal id.';
      }
      const possibleDeals = Array.isArray(lastContactData?.deals) ? lastContactData.deals : [];
      selectedDeal = possibleDeals.find((deal) => {
        const props = deal.properties || {};
        return props.hs_deal_record_id === dealId || String(deal.id) === dealId;
      }) || null;
      if (selectedDeal) {
        currentSelectedDeal = selectedDeal;
      }
      if (dealMessage) {
        dealMessage.textContent = selectedDeal
          ? `Using ${selectedDeal.properties?.dealname || dealId}`
          : `Using manual deal id ${dealId}`;
      }
    } else {
      const dealProps = selectedDeal.properties || {};
      dealId = String(dealProps.hs_deal_record_id || selectedDeal.id || '').trim();
      if (!dealId) {
        metadataStatus.textContent = 'Selected deal is missing an id; please choose another deal.';
        return;
      }
    }

    const payload = {
      folder_id: folderId,
      deal_id: dealId,
      hs_deal_record_id: dealId,
    };

    if (lastContactData && lastContactData.contact) {
      const contact = lastContactData.contact;
      const props = contact.properties || {};
      if (contact.id) payload.hs_contact_id = contact.id;
      if (props.firstname) payload.hs_contact_firstname = props.firstname;
      if (props.lastname) payload.hs_contact_lastname = props.lastname;
      if (props.email) payload.hs_contact_email = props.email;
    }

    if (selectedDeal && selectedDeal.properties) {
      const props = selectedDeal.properties;
      if (props.deal_salutation) payload.deal_salutation = props.deal_salutation;
      if (props.household_type) payload.household_type = props.household_type;
      if (props.hs_spouse_id) payload.hs_spouse_id = props.hs_spouse_id;
      if (props.hs_spouse_firstname) payload.hs_spouse_firstname = props.hs_spouse_firstname;
      if (props.hs_spouse_lastname) payload.hs_spouse_lastname = props.hs_spouse_lastname;
      if (props.hs_spouse_email) payload.hs_spouse_email = props.hs_spouse_email;
    }

    generateMetadataPreview(payload, selectedDeal);
    const confirmed = window.confirm('Apply metadata using the previewed values?');
    if (!confirmed) {
      metadataStatus.textContent = 'Metadata creation cancelled.';
      statusText.textContent = 'Metadata apply cancelled.';
      return;
    }

    statusText.textContent = 'Applying metadata‚Ä¶';
    metadataStatus.textContent = 'Applying metadata‚Ä¶';
    setBusy(metadataButton, true, 'Working‚Ä¶');

    try {
      const data = await fetchJSON('/box/folder/tag/auto', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
      });
      metadataStatus.textContent = `Metadata applied. Fields updated: ${data.metadata_fields.length}`;
      statusText.textContent = `Metadata applied to folder ${data.folder_id}`;
    } catch (error) {
      metadataStatus.textContent = `Metadata creation failed: ${error.message}`;
      statusText.textContent = `Metadata error ¬∑ ${error.message}`;
      errorCard.classList.remove('hidden');
      const detailText = error.detail && Object.keys(error.detail).length
        ? `<br/><code>${JSON.stringify(error.detail, null, 2)}</code>`
        : '';
      errorCard.innerHTML = `<strong>Error:</strong> ${error.message}${detailText}`;
      console.error(error);
    } finally {
      setBusy(metadataButton, false);
    }
  }

  function showError(error) {
    const detail = error.detail || {};
    errorCard.classList.remove('hidden');
    const prettyDetail = detail && Object.keys(detail).length ? JSON.stringify(detail, null, 2) : '';
    errorCard.innerHTML = `<strong>Error:</strong> ${error.message}${prettyDetail ? `<br/><code>${prettyDetail}</code>` : ''}`;
    statusText.textContent = `Error ¬∑ ${error.message}`;
    resultsWrapper.classList.add('hidden');
    externalCard.classList.add('hidden');
    contactCard.classList.add('hidden');
    if (dealCard) dealCard.classList.add('hidden');
    if (dealSelect) dealSelect.innerHTML = '';
    if (dealMessage) dealMessage.textContent = 'Select a deal to load metadata values.';
    if (metadataPreview) {
      metadataPreview.classList.add('hidden');
    }
    if (metadataPreviewContent) {
      metadataPreviewContent.textContent = '';
    }
    console.error(error);
  }

  loadSubfoldersButton.addEventListener('click', () => {
    loadSubfolders();
  });

  rootShowButton.addEventListener('click', () => {
    const folderId = folderInput.value.trim();
    showCollaborators(rootShowButton, folderId, selectedSubfolderId, selectedSubfolderName);
  });

  subfolderShowButton.addEventListener('click', () => {
    const folderId = currentFolderId || folderInput.value.trim();
    if (!selectedSubfolderId) {
      statusText.textContent = 'Select a subfolder before showing collaborators.';
      return;
    }
    showCollaborators(subfolderShowButton, folderId, selectedSubfolderId, selectedSubfolderName);
  });

  resetButton.addEventListener('click', () => {
    folderInput.value = '';
    resetUI();
    folderInput.focus();
  });

  subfolderList.addEventListener('click', (event) => {
    const checkbox = event.target.closest('input[type="checkbox"]');
    if (!checkbox) return;
    if (checkbox.checked) {
      statusText.textContent = `Selected subfolder ${checkbox.dataset.name || checkbox.value}`;
    }
  });

  collabTableBody.addEventListener('click', async (event) => {
    const button = event.target.closest('button[data-email]');
    if (!button) return;
    const email = button.dataset.email;
    if (!email || email === '‚Äî') {
      contactDetails.textContent = 'No email available for this collaborator.';
      contactCard.classList.remove('hidden');
      return;
    }

    setBusy(button, true, 'Loading‚Ä¶');
    try {
      const data = await fetchContactDetails(email);
      renderContactDetails(data);
      if (data && data.contact) {
        statusText.textContent = `Loaded HubSpot details for ${email}`;
      } else {
        statusText.textContent = `No HubSpot match for ${email}`;
      }
    } catch (error) {
      showError(error);
    } finally {
      setBusy(button, false);
    }
  });

  function handleEnterKey(event) {
    if (event.key === 'Enter') {
      event.preventDefault();
      rootShowButton.click();
    }
  }

  folderInput.addEventListener('keypress', handleEnterKey);

  if (metadataButton) {
    metadataButton.addEventListener('click', () => {
      createMetadata();
    });
  }

  function buildMetadataPreview(payload, deal, contact) {
    const primaryName = [payload.hs_contact_firstname, payload.hs_contact_lastname]
      .filter(Boolean)
      .join(' ')
      .trim();
    const spouseName = [payload.hs_spouse_firstname, payload.hs_spouse_lastname]
      .filter(Boolean)
      .join(' ')
      .trim();

    const contacts = {
      primary: {
        id: payload.hs_contact_id || '',
        name: primaryName || '',
        email: payload.hs_contact_email || '',
      },
      spouse: {
        id: payload.hs_spouse_id || '',
        name: spouseName || '',
        email: payload.hs_spouse_email || '',
      },
    };

    const portalId = extractPortalIdFromUrl(contact?.url);
    const primaryLink = contact?.url || buildContactLink(portalId, payload.hs_contact_id);
    const spouseLink = buildContactLink(portalId, payload.hs_spouse_id);

    const associatedIds = [];
    const associatedContacts = [];
    if (payload.hs_contact_id) associatedIds.push(payload.hs_contact_id);
    if (payload.hs_spouse_id) associatedIds.push(payload.hs_spouse_id);

    if (primary.id || primary.name || primary.email) {
      associatedContacts.push(
        formatAssociatedContact({
          name: primary.name || 'Primary Contact',
          email: primary.email,
          id: primary.id,
          link: primaryLink,
        })
      );
    }
    if (spouse.id || spouse.name || spouse.email) {
      associatedContacts.push(
        formatAssociatedContact({
          name: spouse.name || 'Spouse',
          email: spouse.email,
          id: spouse.id,
          link: spouseLink,
        })
      );
    }

    const metadataFields = {
      deal_salutation: payload.deal_salutation || '',
      household_type: payload.household_type || '',
      primary_contact_id: payload.hs_contact_id || '',
      primary_contact_link: primaryLink || '',
      hs_spouse_id: payload.hs_spouse_id || '',
      spouse_contact_link: spouseLink || '',
      associated_contact_ids: associatedIds.join(', ') || '',
      associated_contacts: associatedContacts.join('\n') || '',
    };

    const dealDetails = (() => {
      if (!deal) return undefined;
      const props = deal.properties || {};
      return {
        id: props.hs_deal_record_id || deal.id || '',
        name: props.dealname || '',
        stage: props.dealstage || '',
        close_date: formatDate(extractDealTimestamp(deal)) || '',
      };
    })();

    return {
      folder_id: payload.folder_id,
      deal_id: payload.deal_id,
      deal: dealDetails,
      metadata_fields: metadataFields,
      contacts,
    };
  }

  function extractPortalIdFromUrl(url) {
    if (!url) return '';
    const match = String(url).match(/contacts\/(\d+)\/record/);
    return match ? match[1] : '';
  }

  function buildContactLink(portalId, contactId) {
    if (!portalId || !contactId) return undefined;
    return `https://app.hubspot.com/contacts/${portalId}/record/0-1/${contactId}`;
  }

  function formatAssociatedContact({ name, email, id, link }) {
    const parts = [];
    if (email) parts.push(email);
    if (id) parts.push(`ID: ${id}`);
    if (link) parts.push(`Link: ${link}`);
    if (!parts.length) return name || 'Contact';
    return `${name || 'Contact'} (${parts.join(' | ')})`;
  }

  function parseTimestamp(value) {
    if (!value && value !== 0) return 0;
    if (typeof value === 'number') return value;
    const str = String(value).trim();
    if (!str) return 0;
    if (/^\d+$/.test(str)) {
      const num = Number(str);
      if (Number.isNaN(num)) return 0;
      return num > 1e12 ? num : num * 1000;
    }
    const parsed = Date.parse(str);
    return Number.isNaN(parsed) ? 0 : parsed;
  }

  function extractDealTimestamp(deal) {
    const props = (deal && deal.properties) || {};
    const candidates = [
      props.closedate,
      props.hs_closed_won_date,
      deal?.updatedAt,
      deal?.createdAt,
    ];
    for (const candidate of candidates) {
      const ts = parseTimestamp(candidate);
      if (ts) return ts;
    }
    return 0;
  }

  function formatDate(ts) {
    if (!ts) return 'n/a';
    const d = new Date(ts);
    if (Number.isNaN(d.getTime())) return 'n/a';
    return d.toISOString().slice(0, 10);
  }

  function populateDealDropdown(deals) {
    if (!dealSelect || !dealCard) return;
    if (!Array.isArray(deals) || !deals.length) {
      dealSelect.innerHTML = '';
      dealSelect.disabled = true;
      dealCard.classList.add('hidden');
      if (dealMessage) {
        dealMessage.textContent = 'No associated deals found.';
      }
      currentDealList = [];
      currentSelectedDeal = null;
      return;
    }

    const sorted = [...deals].sort((a, b) => extractDealTimestamp(b) - extractDealTimestamp(a));
    currentDealList = sorted;
    dealSelect.innerHTML = '';

    sorted.forEach((deal, index) => {
      const props = deal.properties || {};
      const displayId = props.hs_deal_record_id || deal.id || `deal-${index}`;
      const name = props.dealname || `Deal ${displayId}`;
      const stage = props.dealstage || 'Unknown stage';
      const closeDate = formatDate(extractDealTimestamp(deal));
      const option = document.createElement('option');
      option.value = String(index);
      option.textContent = `${name} ¬∑ ${stage} ¬∑ ${closeDate}`;
      dealSelect.appendChild(option);
    });

    dealCard.classList.remove('hidden');
    dealSelect.disabled = false;
    if (dealMessage) {
      dealMessage.textContent = 'Select a deal to load metadata values.';
    }
    setSelectedDeal(0, { renderPreview: true });
  }

  function setSelectedDeal(index, options = {}) {
    const renderPreview = options.renderPreview !== false;

    if (!Array.isArray(currentDealList) || !currentDealList[index]) {
      currentSelectedDeal = null;
      if (dealSelect) {
        dealSelect.value = '';
        dealSelect.disabled = true;
      }
      if (dealMessage) dealMessage.textContent = 'Select a deal to load metadata values.';
      if (metadataPreview) metadataPreview.classList.add('hidden');
      if (metadataPreviewContent) metadataPreviewContent.textContent = '';
      return;
    }

    currentSelectedDeal = currentDealList[index];
    if (dealSelect) {
      dealSelect.value = String(index);
      dealSelect.disabled = false;
    }
    const props = currentSelectedDeal.properties || {};
    const displayId = props.hs_deal_record_id || currentSelectedDeal.id || '';
    const name = props.dealname || `Deal ${displayId || currentSelectedDeal.id}`;
    const stage = props.dealstage || 'Unknown stage';
    const closeDate = formatDate(extractDealTimestamp(currentSelectedDeal));
    if (dealMessage) {
      dealMessage.textContent = `Using ${name} ¬∑ Stage: ${stage} ¬∑ Close: ${closeDate}`;
    }
    if (metadataStatus) {
      metadataStatus.textContent = `Deal selected: ${name}. Review the metadata preview before applying.`;
    }
    if (renderPreview) {
      generateMetadataPreview();
    }
  }

  if (dealSelect) {
    dealSelect.addEventListener('change', (event) => {
      const nextIndex = Number(event.target.value);
      setSelectedDeal(Number.isNaN(nextIndex) ? 0 : nextIndex);
    });
  }

  function generateMetadataPreview(existingPayload, selectedDealOverride) {
    const payload = existingPayload || buildPayloadFromSelectedDeal(selectedDealOverride);
    if (!payload) return;
    const previewData = buildMetadataPreview(payload, selectedDealOverride || currentSelectedDeal, lastContactData?.contact);
    if (metadataPreviewContent) {
      metadataPreviewContent.textContent = JSON.stringify(previewData, null, 2);
    }
    if (metadataPreview) {
      metadataPreview.classList.remove('hidden');
    }
    if (metadataStatus) {
      metadataStatus.textContent = 'Metadata preview generated automatically. Review before applying.';
    }
    if (statusText) {
      statusText.textContent = 'Metadata preview generated.';
    }
  }

  function buildPayloadFromSelectedDeal(selectedDealOverride) {
    const folderValue = rootFolderId
      || (lastCollabResponse && lastCollabResponse.folder_id)
      || (lastCollabResponse && lastCollabResponse.inspected && lastCollabResponse.inspected.id)
      || currentFolderId
      || folderInput.value.trim();
    const folderId = normalizeFolderId(folderValue);
    if (!folderId) {
      return null;
    }

    const deal = selectedDealOverride || currentSelectedDeal;
    const dealProps = (deal && deal.properties) || {};
    const dealId = String(dealProps.hs_deal_record_id || deal?.id || '').trim();
    if (!dealId) {
      return null;
    }

    const payload = {
      folder_id: folderId,
      deal_id: dealId,
      hs_deal_record_id: dealId,
    };

    if (lastContactData && lastContactData.contact) {
      const contact = lastContactData.contact;
      const props = contact.properties || {};
      if (contact.id) payload.hs_contact_id = contact.id;
      if (props.firstname) payload.hs_contact_firstname = props.firstname;
      if (props.lastname) payload.hs_contact_lastname = props.lastname;
      if (props.email) payload.hs_contact_email = props.email;
    }

    if (dealProps) {
      if (dealProps.deal_salutation) payload.deal_salutation = dealProps.deal_salutation;
      if (dealProps.household_type) payload.household_type = dealProps.household_type;
      if (dealProps.hs_spouse_id) payload.hs_spouse_id = dealProps.hs_spouse_id;
      if (dealProps.hs_spouse_firstname) payload.hs_spouse_firstname = dealProps.hs_spouse_firstname;
      if (dealProps.hs_spouse_lastname) payload.hs_spouse_lastname = dealProps.hs_spouse_lastname;
      if (dealProps.hs_spouse_email) payload.hs_spouse_email = dealProps.hs_spouse_email;
    }

    return payload;
  }

  resetUI();
</script>
{% endblock %}
