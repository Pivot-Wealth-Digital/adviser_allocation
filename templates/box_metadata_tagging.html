{% extends "layout.html" %}
{% set title = "Box Metadata Tagging Guide" %}

{% block head %}
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css"
  integrity="sha512-bte7mhQjsHMCHztkaXwfFhAoxZjUo4X5cSznbBWYSHzxN6IinxS1T+eVRDVQN+852fzObzSKfJzJzsxL7I3KqQ=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
/>
<script type="module">
  import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
  mermaid.initialize({ startOnLoad: true, theme: "neutral" });
</script>
<style>
  .guide-wrapper {
    background: #f5f7fa;
    padding: 28px;
    border-radius: 16px;
    box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.06);
    color: #1f2933;
    line-height: 1.6;
  }

  .guide-wrapper section {
    margin-bottom: 28px;
  }

  .guide-wrapper header {
    margin-bottom: 32px;
  }

  .guide-wrapper header h1 {
    margin-bottom: 12px;
  }

  .guide-wrapper .diagram {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 12px 24px rgba(15, 23, 42, 0.1);
    padding: 24px;
    margin-top: 16px;
  }

  .guide-wrapper .diagram pre {
    margin: 0;
  }

  .guide-wrapper .callout {
    background: rgba(59, 130, 246, 0.08);
    border-left: 4px solid #2563eb;
    padding: 16px 20px;
    border-radius: 6px;
  }

  .guide-wrapper .steps ol {
    padding-left: 18px;
  }

  .guide-wrapper .steps li + li {
    margin-top: 8px;
  }

  .guide-wrapper .checklist ul {
    padding-left: 18px;
  }

  .guide-wrapper .checklist li + li {
    margin-top: 6px;
  }

  .step-gallery {
    margin-top: 28px;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .step-card {
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
    padding: 18px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .step-card img {
    width: 100%;
    border-radius: 12px;
    box-shadow: 0 12px 26px rgba(99, 102, 241, 0.18);
  }

  .step-card h3 {
    margin: 0;
    font-size: 20px;
  }

  .step-card p {
    margin: 0;
    color: #475569;
    font-size: 15px;
    line-height: 1.5;
  }
</style>
{% endblock %}

{% block content %}
<div class="guide-wrapper">
  <header>
    <h1>Box Metadata Tagging Guide</h1>
    <p>
      Use this walkthrough when manually tagging client folders. Start from the metadata status dashboard,
      review collaborators, confirm the HubSpot match, then apply the metadata template with confidence.
    </p>
  </header>

  <section class="steps">
    <h2>Quick Steps</h2>
    <ol>
      <li>Visit <code>/box/folder/metadata/status</code> and open your assigned slot.</li>
      <li>Launch the collaborators view for an untagged folder.</li>
      <li>Display subfolders and choose the client sharing subfolder to analyze.</li>
      <li>Focus on external collaborators and pull matching HubSpot contact details.</li>
      <li>Preview metadata, verify each field (especially folder name vs primary contact), then apply the template.</li>
    </ol>
    <div class="step-gallery">
      <div class="step-card">
        <img src="{{ url_for('static', filename='images/box_metadata/step1.png') }}" alt="Step 1 – Open metadata status dashboard" />
        <h3>Step 1 · Metadata Status</h3>
        <p>Identify the folders assigned to you from the status dashboard.</p>
      </div>
      <div class="step-card">
        <img src="{{ url_for('static', filename='images/box_metadata/step2.png') }}" alt="Step 2 – Launch collaborators view" />
        <h3>Step 2 · Collaborators View</h3>
        <p>Open the collaborators UI for deeper folder analysis.</p>
      </div>
      <div class="step-card">
        <img src="{{ url_for('static', filename='images/box_metadata/step3.png') }}" alt="Step 3 – Inspect subfolders and emails" />
        <h3>Step 3 · Subfolders & Emails</h3>
        <p>Review external access from the client sharing folder.</p>
      </div>
      <div class="step-card">
        <img src="{{ url_for('static', filename='images/box_metadata/step4.png') }}" alt="Step 4 – Review HubSpot context" />
        <h3>Step 4 · HubSpot Context</h3>
        <p>Cross-check contacts and deals pulled from HubSpot.</p>
      </div>
      <div class="step-card">
        <img src="{{ url_for('static', filename='images/box_metadata/step5.png') }}" alt="Step 5 – Preview and apply metadata" />
        <h3>Step 5 · Apply Metadata</h3>
        <p>Preview, validate, and apply the metadata template.</p>
      </div>
    </div>
  </section>

  <section>
    <h2>User Journey</h2>
    <p>
      The flowchart illustrates the path from the metadata dashboard to the final tagging action.
    </p>
    <div class="diagram">
      <div class="mermaid">
        flowchart TD
            subgraph Dashboard Access
                U[User] --> S[Start at Metadata Status]
                S --> Slot[Expand Assigned Slot]
            end

            Slot --> Decision{Untagged folder available?}
            Decision -->|No| Done[Pick another slot]

            subgraph Collaborators View
                Decision -->|Yes| CollabBtn[Open Collaborators]
                CollabBtn --> Tab[Collaborators UI\n/box/collaborators?folder_id=...]
                Tab --> Subfolders[Display Subfolders]
                Subfolders --> PickSubfolder[Select Client Sharing folder]
            end

            subgraph Verification
                PickSubfolder --> ExternalEmails[Review external collaborator emails]
                ExternalEmails --> ContactMatch[Load HubSpot details]
                ContactMatch --> Preview[Preview metadata fields]
            end

            Preview --> Confirm[Confirm folder name matches contact/deal]
            Confirm --> Apply[Create metadata and tag folder]
      </div>
    </div>
  </section>

  <section>
    <h2>API Interaction Map</h2>
    <p>
      The sequence diagram shows the key requests triggered during tagging.
    </p>
    <div class="diagram">
      <div class="mermaid">
        sequenceDiagram
            participant User
            participant UI as Browser UI
            participant App as Adviser API
            participant BoxAPI as Box API
            participant HubSpot

            User->>UI: Open /box/folder/metadata/status
            UI->>App: GET /box/folder/metadata/status render
            App->>UI: Page data

            User->>UI: Click 'View Subfolders'
            UI->>App: GET /box/folder/subfolders?folder_id=ID
            App->>BoxAPI: GET folder children
            BoxAPI->>App: Subfolder list
            App->>UI: Subfolder data UI displays list

            User->>UI: Click 'View Collaborators'
            UI->>App: GET /box/folder/collaborators?folder_id=ID
            App->>BoxAPI: GET collaborations
            BoxAPI->>App: Collaborator entries
            App->>UI: External collaborators UI displays list

            User->>UI: Click on a collaborator's email
            UI->>App: GET /box/collaborators/contact?email=...
            App->>HubSpot: Search contact and deals
            HubSpot->>App: Contact plus associated deals
            App->>UI: Contact profile and deal list

            User->>UI: Click 'Apply Metadata'
            UI->>App: POST /box/folder/tag/auto
            App->>BoxAPI: PUT metadata template
            BoxAPI->>App: Tagging status
            App->>HubSpot: PATCH contact or deal update box_folder
            HubSpot->>App: Update confirmation
            App->>UI: Metadata applied response
      </div>
    </div>
  </section>

  <section>
    <h2>Folder State Timeline</h2>
    <p>Track how a folder progresses during review and tagging.</p>
    <div class="diagram">
      <div class="mermaid">
        stateDiagram-v2
            [*] --> Untagged
            Untagged: Appears in metadata status slot
            Untagged --> Inspecting: Collaborators view opened\nand subfolder selected
            Inspecting --> Matching: HubSpot contact identified\nand deal confirmed
            Matching --> Previewed: Metadata preview generated
            Previewed --> Tagged: Template apply succeeds
            Previewed --> Untagged: Cancel or mismatch detected
            Tagged --> [*]
      </div>
    </div>
  </section>

  <section class="checklist">
    <h2>Verification Checklist</h2>
    <ul>
      <li><strong>Folder naming:</strong> Root and subfolder names should align with the primary contact or household naming convention from HubSpot.</li>
      <li><strong>External email:</strong> Confirm the external collaborator email belongs to the intended household.</li>
      <li><strong>Deal alignment:</strong> Ensure the highlighted HubSpot deal is the active engagement.</li>
      <li><strong>Spouse & contacts:</strong> When a spouse exists in HubSpot, confirm their fields populate the preview. Blank values are fine if no spouse contact exists.</li>
      <li><strong>Metadata result:</strong> After tagging, confirm Box displays the metadata template and HubSpot reflects the updated box folder link.</li>
    </ul>
  </section>

  <section class="callout">
    <h3>Tips & Troubleshooting</h3>
    <ul>
      <li>If subfolders fail to load, verify folder id and editor access, then retry “Display Subfolders”.</li>
      <li>No HubSpot contact? Double-check the external email spelling or search HubSpot manually before tagging.</li>
      <li>Metadata apply errors (e.g. <code>415</code>) usually mean the template name or scope is misconfigured.</li>
      <li>When the preview looks off, cancel and revisit the folder name/contact association before applying metadata.</li>
    </ul>
  </section>
</div>
{% endblock %}
