{% extends 'layout.html' %}
{% set title = 'Adviser Meetings' %}

{% block content %}
<div class="topbar">
  <div style="display: flex; align-items: center; gap: 16px;">
    <a href="/" style="color: #d0d7e2; text-decoration: none; font-size: 0.9em;">&larr; Home</a>
    <h2>Adviser Meetings</h2>
  </div>
  <div class="datebox"><span>Today: {{ today }}</span><span>Week: {{ week_num }}</span></div>
</div>

<div class="card guide-card">
  <div class="card-header">
    <h3>Filter</h3>
  </div>
  <p class="muted inline-guide-title">See Clarify / Kick Off meetings for an adviser</p>
  <div class="row">
    <div>
      <label for="adviserSelect">Adviser</label>
      <select id="adviserSelect">
        {{ options_html|safe }}
      </select>
    </div>
    <div>
      <label for="weeksBack">Weeks of history</label>
      <input type="number" min="1" max="52" id="weeksBack" value="{{ weeks_back }}" />
      <span class="col-helper">Starting from the Monday {{ since_label if since_label else 'derived from weeks back' }}</span>
    </div>
    <div>
      <button id="fetchBtn" class="primary">Fetch meetings</button>
    </div>
  </div>
  <p class="muted" style="margin-top:12px;">Times are shown in Sydney. Window includes any future meetings after the start date.</p>
</div>

{% if compute and selected and not error_msg %}
  <p class="muted" style="margin: 8px 0 4px 0;">Showing meetings for <strong>{{ selected }}</strong> since <strong>{{ since_label }}</strong> ({{ weeks_back }} week{{ 's' if weeks_back|int != 1 else '' }} back).</p>
{% endif %}

<table>
  <thead>
    <tr>
      <th class="nowrap">Date (Sydney)</th>
      <th>Time</th>
      <th>Type</th>
      <th>Title</th>
      <th>Outcome</th>
      <th>HubSpot</th>
    </tr>
  </thead>
  <tbody>
    {% if error_msg %}
      <tr><td colspan="6" style="color:var(--err);">{{ error_msg }}</td></tr>
    {% elif compute and selected %}
      {% if rows %}
        {% for m in rows %}
          <tr>
            <td class="nowrap">{{ m.date }}</td>
            <td class="nowrap">{{ m.time }}</td>
            <td><span class="pill pill-{{ m.type|lower|replace(' ', '-') }}">{{ m.type }}</span></td>
            <td>{{ m.title }}</td>
            <td>{{ m.outcome }}</td>
            <td>
              {% if m.link %}
                <a href="{{ m.link }}" target="_blank" rel="noopener">Open</a>
              {% else %}
                â€”
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="6">No meetings found for this window.</td></tr>
      {% endif %}
    {% else %}
      <tr><td colspan="6" style="text-align:center;color:var(--muted);padding:24px;">Select an adviser and click "Fetch meetings" to list Clarify/Kick Off bookings.</td></tr>
    {% endif %}
  </tbody>
</table>
{% endblock %}

{% block head %}
{{ super() }}
<style>
  .pill {
    display: inline-flex;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.85em;
    background: #e4e9f2;
    color: #1a2b4c;
  }
  .pill-clarify { background: #e6f4ea; color: #1b4332; }
  .pill-kick-off { background: #e8f0fe; color: #1a237e; }
  .guide-card h3 { margin: 0; }
  .inline-guide-title { margin: 0 0 8px 0; }
</style>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const adviserSelect = document.getElementById('adviserSelect');
  const weeksBackInput = document.getElementById('weeksBack');
  const fetchBtn = document.getElementById('fetchBtn');
  const currentSelected = "{{ selected }}";

  if (currentSelected && adviserSelect) {
    adviserSelect.value = currentSelected;
  }

  if (fetchBtn) {
    fetchBtn.addEventListener('click', function() {
      const adviser = adviserSelect ? adviserSelect.value : '';
      const weeksBackRaw = weeksBackInput ? weeksBackInput.value : '8';
      if (!adviser) {
        alert('Please select an adviser');
        return;
      }
      const weeks = Math.min(52, Math.max(1, parseInt(weeksBackRaw || '8', 10)));
      const params = new URLSearchParams({
        compute: '1',
        email: adviser,
        weeks_back: String(weeks)
      });
      window.location.href = '?' + params.toString();
    });
  }
})();
</script>
{% endblock %}
