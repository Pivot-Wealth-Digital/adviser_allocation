{% extends "layout.html" %}
{% set title = "Manual Metadata Tagging" %}

{% block content %}
<div class="admin-tools-card">
  <h2>Manual Metadata Tagging</h2>
  <p class="muted">
    Already know the HubSpot contact (and optional deal) that should drive metadata for a folder? Submit the details below
    to preview and apply the metadata.
  </p>

  <div style="margin: 16px 0; padding: 12px; background: #f8fafc; border-left: 3px solid #F08354; border-radius: 4px;">
    <p style="margin: 0 0 8px 0; font-weight: 600; color: #1f2937;">Quick Guide:</p>
    <ul style="margin: 0; padding-left: 20px; font-size: 0.9em; color: #475467;">
      <li>Find the Box folder ID from the folder URL in Box</li>
      <li>Find the HubSpot contact ID from the contact record in HubSpot</li>
      <li>Preview the metadata before applying to verify it's correct</li>
      <li>Once applied, metadata will be visible in Box's folder details</li>
    </ul>
  </div>

  <form id="manual-tag-form" class="manual-tag-form">
    <label>
      <div class="label-text">
        Box folder ID
        <span class="tooltip-icon" data-tooltip="Open the folder in Box and copy the ID from the URL (e.g., box.com/folder/12345)" tabindex="0">?</span>
      </div>
      <input type="text" name="folder_id" required placeholder="e.g. 148851810344" autocomplete="off" />
    </label>
    <label>
      <div class="label-text">
        HubSpot contact ID
        <span class="tooltip-icon" data-tooltip="Open the contact in HubSpot and copy the ID from the URL" tabindex="0">?</span>
      </div>
      <input type="text" name="contact_id" required placeholder="e.g. 81428472235" autocomplete="off" />
    </label>
    <label>
      <div class="label-text">
        HubSpot deal ID (optional)
        <span class="tooltip-icon" data-tooltip="Open the deal in HubSpot and copy the ID from the URL. Leave blank to use contact data only." tabindex="0">?</span>
      </div>
      <input type="text" name="deal_id" placeholder="e.g. 32347298416" autocomplete="off" />
    </label>
    <button type="submit" class="secondary" id="manual-tag-submit" data-default="Preview metadata">
      Preview metadata
    </button>
    <p id="manual-tag-status" class="muted small"></p>
  </form>

  <div class="faq-card">
    <h3 style="margin: 0 0 12px 0; font-size: 1.1rem; color: #1f2937;">Frequently Asked Questions</h3>
    <div class="faq-accordion">
      <div class="faq-item">
        <button class="faq-question" type="button" aria-expanded="false">
          <span>How do I find a Box folder ID?</span>
          <span class="faq-chevron" aria-hidden="true">&#9662;</span>
        </button>
        <div class="faq-answer" hidden>
          <ol style="margin: 0; padding-left: 20px;">
            <li>Navigate to Box and open the client folder</li>
            <li>Look at the URL in your browser address bar</li>
            <li>The folder ID is the number after <code>/folder/</code> in the URL</li>
            <li>Example: <code>https://app.box.com/folder/148851810344</code> â†’ ID is <code>148851810344</code></li>
          </ol>
        </div>
      </div>

      <div class="faq-item">
        <button class="faq-question" type="button" aria-expanded="false">
          <span>How do I find a HubSpot contact ID?</span>
          <span class="faq-chevron" aria-hidden="true">&#9662;</span>
        </button>
        <div class="faq-answer" hidden>
          <ol style="margin: 0; padding-left: 20px;">
            <li>Open HubSpot and navigate to the contact record</li>
            <li>Look at the URL in your browser address bar</li>
            <li>The contact ID is the last number in the URL path</li>
            <li>Example: <code>https://app.hubspot.com/contacts/47011873/record/0-1/81428472235</code> â†’ ID is <code>81428472235</code></li>
          </ol>
        </div>
      </div>

      <div class="faq-item">
        <button class="faq-question" type="button" aria-expanded="false">
          <span>How do I find a HubSpot deal ID?</span>
          <span class="faq-chevron" aria-hidden="true">&#9662;</span>
        </button>
        <div class="faq-answer" hidden>
          <ol style="margin: 0; padding-left: 20px;">
            <li>Open HubSpot and navigate to the deal record</li>
            <li>Look at the URL in your browser address bar</li>
            <li>The deal ID is the last number in the URL path</li>
            <li>Example: <code>https://app.hubspot.com/contacts/47011873/deal/32347298416</code> â†’ ID is <code>32347298416</code></li>
          </ol>
        </div>
      </div>

      <div class="faq-item">
        <button class="faq-question" type="button" aria-expanded="false">
          <span>When should I include a deal ID?</span>
          <span class="faq-chevron" aria-hidden="true">&#9662;</span>
        </button>
        <div class="faq-answer" hidden>
          <ul style="margin: 0; padding-left: 20px;">
            <li>Include a deal ID when you want the metadata to reflect specific deal information</li>
            <li>If you only provide a contact ID, the system will search for associated deals automatically</li>
            <li>Providing a deal ID ensures the exact deal is used for metadata</li>
          </ul>
        </div>
      </div>

      <div class="faq-item">
        <button class="faq-question" type="button" aria-expanded="false">
          <span>ðŸ“¹ Is there a video tutorial?</span>
          <span class="faq-chevron" aria-hidden="true">&#9662;</span>
        </button>
        <div class="faq-answer" hidden>
          <p><a href="https://www.loom.com/share/placeholder" target="_blank" rel="noopener" style="color: #F08354; text-decoration: none; font-weight: 500;">Watch the step-by-step tutorial (2 minutes)</a></p>
          <p>The video covers:</p>
          <ul style="margin: 4px 0; padding-left: 20px;">
            <li>Finding Box folder IDs in the URL</li>
            <li>Finding HubSpot contact IDs in the URL</li>
            <li>Previewing metadata before applying</li>
            <li>Applying metadata to a Box folder</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div id="manual-preview-card" class="manual-preview hidden">
    <h3>Preview result</h3>
    <div id="manual-preview-summary" class="muted small"></div>
    <div id="manual-preview-table" class="manual-preview-table"></div>
    <button type="button" class="secondary" id="manual-preview-apply" data-default="Apply this metadata" disabled>
      Apply this metadata
    </button>
    <p id="manual-preview-status" class="muted small"></p>
  </div>
</div>
{% endblock %}

{% block head %}
<style>
  .admin-tools-card {
    max-width: 800px;
    margin: 0 auto;
    padding: 24px;
    background: white;
    border-radius: 8px;
    border: 1px solid var(--border);
  }

  .admin-tools-card h2 {
    margin: 0 0 12px 0;
    font-size: 1.5rem;
    color: #1f2937;
  }

  .manual-tag-form {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 12px;
  }

  .manual-tag-form label {
    display: block;
    font-size: 0.9em;
    color: #475467;
    margin-bottom: 4px;
  }

  .label-text {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 4px;
  }

  .tooltip-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    background: #e5e7eb;
    border-radius: 50%;
    font-size: 0.75em;
    font-weight: 600;
    color: #6b7280;
    cursor: help;
    flex-shrink: 0;
    position: relative;
  }

  .tooltip-icon:hover::after,
  .tooltip-icon:focus::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    background: #1f2937;
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 0.85em;
    white-space: nowrap;
    z-index: 10;
    pointer-events: none;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }

  .manual-tag-form input {
    padding: 8px;
    border: 1px solid #cbd5f5;
    border-radius: 4px;
    font-size: 0.95em;
  }

  .manual-preview {
    margin-top: 16px;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: #f8fafc;
  }

  .manual-preview h3 {
    margin: 0 0 8px 0;
    font-size: 1rem;
    color: #1f2937;
  }

  .manual-preview-table {
    margin: 12px 0;
  }

  .manual-preview-table table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9em;
  }

  .manual-preview-table th,
  .manual-preview-table td {
    padding: 8px;
    border-bottom: 1px solid #e5e7eb;
    text-align: left;
  }

  .manual-preview-table thead {
    background: #f3f4f6;
  }

  .manual-preview-table th {
    font-weight: 600;
    color: #374151;
  }

  .manual-preview-table td {
    color: #6b7280;
  }

  .hidden {
    display: none;
  }

  .err {
    color: #dc2626;
    font-weight: 500;
  }

  button.secondary {
    padding: 10px 16px;
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.95em;
    cursor: pointer;
    transition: all 0.2s;
  }

  button.secondary:hover:not(:disabled) {
    background: #e5e7eb;
  }

  button.secondary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .muted {
    color: #6b7280;
  }

  .muted.small {
    font-size: 0.85em;
  }

  .faq-card {
    margin-top: 24px;
    padding: 20px;
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
  }

  .faq-accordion {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .faq-item {
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    overflow: hidden;
  }

  .faq-question {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: #f9fafb;
    border: none;
    cursor: pointer;
    font-size: 0.95em;
    font-weight: 500;
    color: #1f2937;
    text-align: left;
    transition: background 0.2s;
  }

  .faq-question:hover {
    background: #f3f4f6;
  }

  .faq-question[aria-expanded="true"] {
    background: #f3f4f6;
  }

  .faq-chevron {
    font-size: 0.8em;
    color: #6b7280;
    transition: transform 0.2s;
    margin-left: 8px;
  }

  .faq-question[aria-expanded="true"] .faq-chevron {
    transform: rotate(180deg);
  }

  .faq-answer {
    padding: 12px 16px;
    font-size: 0.9em;
    color: #475467;
    line-height: 1.6;
    background: white;
  }

  .faq-answer p {
    margin: 0 0 8px 0;
  }

  .faq-answer ol,
  .faq-answer ul {
    margin: 8px 0;
    padding-left: 20px;
  }

  .faq-answer li {
    margin: 4px 0;
  }

  .faq-answer code {
    background: #f3f4f6;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.9em;
    color: #1f2937;
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  function escapeHtml(unsafe) {
    return (unsafe || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function formatMetadataValue(value) {
    if (value === null || value === undefined) {
      return '<span class="muted">null</span>';
    }
    if (typeof value === "boolean") {
      return value ? "true" : "false";
    }
    if (Array.isArray(value)) {
      return escapeHtml(JSON.stringify(value, null, 2));
    }
    if (typeof value === "object") {
      return escapeHtml(JSON.stringify(value, null, 2));
    }
    return escapeHtml(String(value));
  }

  async function fetchJSON(url, options = {}) {
    const response = await fetch(url, options);
    if (!response.ok) {
      const text = await response.text();
      try {
        const error = JSON.parse(text);
        throw new Error(error.message || `HTTP ${response.status}`);
      } catch {
        throw new Error(text || `HTTP ${response.status}`);
      }
    }
    return await response.json();
  }

  (function () {
    const manualTagForm = document.getElementById("manual-tag-form");
    const manualTagStatus = document.getElementById("manual-tag-status");
    const manualTagSubmit = document.getElementById("manual-tag-submit");
    const manualPreviewCard = document.getElementById("manual-preview-card");
    const manualPreviewSummary = document.getElementById("manual-preview-summary");
    const manualPreviewTable = document.getElementById("manual-preview-table");
    const manualPreviewApply = document.getElementById("manual-preview-apply");
    const manualPreviewStatus = document.getElementById("manual-preview-status");
    let manualPreviewPayload = null;

    function renderManualPreview(finalPayload, preview) {
      if (!manualPreviewCard || !manualPreviewSummary || !manualPreviewTable) {
        return;
      }
      const dealInfo = preview?.deal || {};
      const contactInfo = preview?.contacts?.primary || {};
      manualPreviewSummary.innerHTML = `
        <div><strong>Primary contact:</strong> ${escapeHtml(contactInfo.name || contactInfo.email || contactInfo.id || "n/a")}</div>
        <div><strong>Deal:</strong> ${escapeHtml(dealInfo.name || dealInfo.id || "n/a")}</div>
      `;
      manualPreviewTable.innerHTML = `
        <table>
          <thead><tr><th>Field</th><th>Value</th></tr></thead>
          <tbody>
            ${Object.entries(finalPayload || {})
              .map(
                ([key, value]) =>
                  `<tr><th>${escapeHtml(key)}</th><td>${formatMetadataValue(value)}</td></tr>`,
              )
              .join("")}
          </tbody>
        </table>
      `;
      manualPreviewCard.classList.remove("hidden");
    }

    if (manualTagForm && manualTagStatus && manualTagSubmit) {
      manualTagForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        manualTagStatus.textContent = "";
        manualTagStatus.classList.remove("err");
        const formData = new FormData(manualTagForm);
        const folderId = (formData.get("folder_id") || "").trim();
        const contactId = (formData.get("contact_id") || "").trim();
        const dealId = (formData.get("deal_id") || "").trim();
        if (!folderId || !contactId) {
          manualTagStatus.textContent = "Folder ID and contact ID are required.";
          manualTagStatus.classList.add("err");
          return;
        }
        manualTagSubmit.disabled = true;
        manualTagSubmit.textContent = "Previewingâ€¦";
        try {
          const payload = await fetchJSON("/box/folder/metadata/manual-preview", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "same-origin",
            body: JSON.stringify({
              folder_id: folderId,
              contact_id: contactId,
              deal_id: dealId || undefined,
            }),
          });
          manualPreviewPayload = {
            folder_id: payload.folder_id,
            contact_id: contactId,
            deal_id: dealId || undefined,
            metadata_fields: payload.metadata_fields,
            final_payload: payload.final_payload,
          };
          renderManualPreview(payload.final_payload, payload.preview);
          manualTagStatus.textContent = `Preview generated for folder ${payload.folder_id}. Review below, then apply when ready.`;
          manualPreviewStatus.textContent = "";
          if (manualPreviewApply) {
            manualPreviewApply.disabled = !manualPreviewPayload;
            manualPreviewApply.classList.remove("hidden");
          }
        } catch (error) {
          manualTagStatus.textContent = `Manual tag failed: ${error.message}`;
          manualTagStatus.classList.add("err");
          manualPreviewPayload = null;
          if (manualPreviewCard) {
            manualPreviewCard.classList.add("hidden");
          }
        } finally {
          manualTagSubmit.disabled = false;
          manualTagSubmit.textContent = manualTagSubmit.dataset.default || "Preview metadata";
        }
      });
    }

    if (manualPreviewApply && manualPreviewStatus) {
      manualPreviewApply.addEventListener("click", async () => {
        if (!manualPreviewPayload) {
          manualPreviewStatus.textContent = "Preview payload missing; generate a preview first.";
          manualPreviewStatus.classList.add("err");
          return;
        }
        manualPreviewStatus.textContent = "";
        manualPreviewStatus.classList.remove("err");
        manualPreviewApply.disabled = true;
        manualPreviewApply.textContent = "Applyingâ€¦";
        try {
          const response = await fetchJSON("/box/folder/metadata/manual-apply", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "same-origin",
            body: JSON.stringify(manualPreviewPayload),
          });
          manualPreviewStatus.textContent = `Metadata applied to folder ${response.folder_id}. The Box folder has been tagged.`;
          manualPreviewApply.disabled = true;
          manualPreviewApply.textContent = "Applied";
        } catch (error) {
          manualPreviewStatus.textContent = `Apply failed: ${error.message}`;
          manualPreviewStatus.classList.add("err");
          manualPreviewApply.disabled = false;
          manualPreviewApply.textContent = manualPreviewApply.dataset.default || "Apply this metadata";
        }
      });
    }
  })();

  // FAQ accordion functionality
  (function () {
    const faqButtons = document.querySelectorAll('.faq-question');
    faqButtons.forEach((btn) => {
      const answer = btn.nextElementSibling;
      if (answer) answer.hidden = true;
      btn.addEventListener('click', () => {
        const expanded = btn.getAttribute('aria-expanded') === 'true';
        btn.setAttribute('aria-expanded', !expanded ? 'true' : 'false');
        if (answer) answer.hidden = expanded;
      });
    });
  })();
</script>
{% endblock %}
