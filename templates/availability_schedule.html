{% extends 'layout.html' %}
{% set title = 'Adviser Schedule' %}

{% block content %}
<div class="topbar">
  <h2>Adviser Schedule</h2>
  <div class="datebox"><span>Today: {{ today }}</span><span>Week: {{ week_num }}</span></div>
  <div id="msg" class="msg" style="display:none"></div>
  <div id="toast-ok" class="msg ok" style="display:none"></div>
  <div id="toast-err" class="msg err" style="display:none"></div>
</div>

<div class="row">
  <label for="email">Adviser:</label>
  <select id="email" name="email" onchange="location='?email='+encodeURIComponent(this.value)">
    {{ options_html|safe }}
  </select>
  <button id="toggle-edit" class="secondary" style="margin-left:8px">Edit</button>
  <button id="done-edit" class="secondary" style="display:none;margin-left:4px">Done</button>
</div>

<table>
  <thead>
    <tr>
      <th>Week</th>
      <th>Monday Date</th>
      <th>Clarify Count</th>
      <th>OOO</th>
      <th>Deal No Clarify</th>
      <th>Target</th>
      <th>Actual</th>
      <th>Difference</th>
    </tr>
  </thead>
  <tbody>
    {% if rows %}
      {% for r in rows %}
        <tr{% if r.is_earliest %} class="hl"{% endif %}>
          <td>{{ r.wk_label }}</td>
          <td>{{ r.monday }}</td>
          <td data-field="clarify">{{ r.clarify }}</td>
          <td>{{ r.ooo }}</td>
          <td data-field="deals">{{ r.deals }}</td>
          <td data-field="target">{{ r.target }}</td>
          <td data-field="actual">{{ r.actual }}</td>
          <td data-field="diff">{{ r.diff }}</td>
        </tr>
      {% endfor %}
    {% else %}
      <tr><td colspan="8">Select an adviser to view schedule.</td></tr>
    {% endif %}
  </tbody>
</table>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const editBtn=document.getElementById('toggle-edit');
  const doneBtn=document.getElementById('done-edit');
  const table=document.querySelector('table');
  if(!table) return;

  function getNumFromCell(td){
    if(!td) return 0;
    const input = td.querySelector('input');
    const raw = input ? input.value : (td.dataset.value || td.textContent || '0');
    const n = parseFloat(String(raw).replace(/[^0-9.-]/g,''));
    return isNaN(n) ? 0 : n;
  }

  function recalc(){
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    let prevClarify = 0;
    rows.forEach(tr => {
      const tdClarify = tr.querySelector('td[data-field="clarify"]');
      const tdTarget  = tr.querySelector('td[data-field="target"]');
      const tdActual  = tr.querySelector('td[data-field="actual"]');
      const tdDiff    = tr.querySelector('td[data-field="diff"]');
      const c = getNumFromCell(tdClarify);
      const t = getNumFromCell(tdTarget);
      const actual = c + prevClarify;
      const diff = actual - t;
      if(tdActual) tdActual.textContent = String(actual);
      if(tdDiff) tdDiff.textContent = String(diff);
      prevClarify = c;
    });
  }

  function enterEdit(){
    doneBtn.style.display='inline-block';
    editBtn.style.display='none';
    Array.from(table.querySelectorAll('tbody tr')).forEach(tr => {
      ['clarify','deals'].forEach(f => {
        const td = tr.querySelector(`td[data-field="${f}"]`);
        if(!td) return;
        const val = (td.dataset.value || td.textContent || '0').trim();
        td.dataset.value = val;
        td.innerHTML = `<input type="number" min="0" step="1" value="${val}">`;
      });
    });
    recalc();
  }

  function exitEdit(){
    doneBtn.style.display='none';
    editBtn.style.display='inline-block';
    Array.from(table.querySelectorAll('tbody tr')).forEach(tr => {
      ['clarify','deals'].forEach(f => {
        const td = tr.querySelector(`td[data-field="${f}"]`);
        if(!td) return;
        const input = td.querySelector('input');
        const val = input ? input.value : (td.textContent || '0');
        td.textContent = val;
        td.dataset.value = val;
      });
    });
    recalc();
  }

  function onInput(e){
    const el = e.target;
    if(el && el.tagName === 'INPUT') recalc();
  }

  if(editBtn) editBtn.addEventListener('click', enterEdit);
  if(doneBtn) doneBtn.addEventListener('click', exitEdit);
  table.addEventListener('input', onInput);
})();
</script>
{% endblock %}
