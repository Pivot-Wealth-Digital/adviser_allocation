{% extends 'layout.html' %}
{% set title = 'Adviser Schedule' %}

{% block content %}
<div class="topbar">
  <div style="display: flex; align-items: center; gap: 16px;">
    <a href="/" style="color: #d0d7e2; text-decoration: none; font-size: 0.9em;">‚Üê Home</a>
    <h2>Adviser Schedule</h2>
  </div>
  <div class="datebox"><span>Today: {{ today }}</span><span>Week: {{ week_num }}</span></div>
  <div id="msg" class="msg" style="display:none"></div>
  <div id="toast-ok" class="msg ok" style="display:none"></div>
  <div id="toast-err" class="msg err" style="display:none"></div>
</div>

<div class="card guide-card">
  <div class="card-header">
    <h3>Compute Schedule</h3>
    <label class="helper-toggle" title="Toggle helper content">
      <input type="checkbox" id="toggleHelpers" checked>
      Show helper tips
    </label>
  </div>
  <p class="muted inline-guide-title">Quick guide</p>
  <ul class="inline-guide">
    <li>Select an adviser and agreement start date before computing the schedule.</li>
    <li>Highlighted rows show the next available clarify fortnight for the adviser.</li>
    <li>Use Edit/Done/Reset to fine-tune clarify counts or deal allocations.</li>
  </ul>
  <div class="row">
    <div>
      <label for="adviserSelect">Adviser</label>
      <select id="adviserSelect">
        {{ options_html|safe }}
      </select>
    </div>
    <div>
      <label for="agreementStartDate">Agreement Start Date</label>
      <input type="date" id="agreementStartDate" value="{{ default_date }}" />
    </div>
    <div>
      <button id="computeBtn" class="primary">Compute Schedule</button>
    </div>
  </div>
  <div id="loading" style="display:none;margin-top:12px;color:var(--muted);">
    <span>üîÑ Computing adviser schedule...</span>
  </div>
</div>

<div class="row" {% if not compute or not selected %}style="display:none"{% endif %}>
  <button id="toggle-edit" class="secondary" style="margin-left:8px">Edit</button>
  <button id="done-edit" class="secondary" style="display:none;margin-left:4px">Done</button>
  <button id="reset-edit" class="secondary" style="display:none;margin-left:4px">Reset</button>
</div>

<table>
  <thead>
    <tr>
      <th>
        Week
        <div class="col-helper">Fortnight label for the schedule row</div>
      </th>
      <th class="nowrap">
        Monday Date
        <div class="col-helper">Monday anchoring the fortnight</div>
      </th>
      <th>
        Clarify Count
        <div class="col-helper">Clarify meetings booked this week</div>
      </th>
      <th>
        OOO
        <div class="col-helper">Out-of-office or closure notes</div>
      </th>
      <th>
        Deal No Clarify
        <div class="col-helper">Deals without a scheduled clarify session</div>
      </th>
      <th>
        Target
        <div class="col-helper">Fortnight clarify target</div>
      </th>
      <th>
        Actual
        <div class="col-helper">Clarifies after adding carry-over</div>
      </th>
      <th>
        Difference
        <div class="col-helper">Actual minus target; overflow carries forward</div>
      </th>
    </tr>
  </thead>
  <tbody>
    {% if compute and selected and rows %}
      {% for r in rows %}
        <tr{% if r.is_earliest %} class="hl"{% endif %}>
          <td>{{ r.wk_label }}</td>
          <td class="nowrap">{{ r.monday }}</td>
          <td data-field="clarify">{{ r.clarify }}</td>
          <td>{{ r.ooo }}</td>
          <td data-field="deals">{{ r.deals }}</td>
          <td data-field="target">{{ r.target }}</td>
          <td data-field="actual">{{ r.actual }}</td>
          <td data-field="diff">{{ r.diff }}</td>
        </tr>
      {% endfor %}
    {% elif compute and selected and not rows %}
      <tr><td colspan="8">No schedule data found for the selected adviser.</td></tr>
    {% else %}
      <tr><td colspan="8" style="text-align:center;color:var(--muted);padding:24px;">Select an adviser and click "Compute Schedule" to view weekly capacity data.</td></tr>
    {% endif %}
  </tbody>
</table>

{% endblock %}

{% block head %}
{{ super() }}
<style>
  .guide-card .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    margin-bottom: 12px;
  }

  .guide-card h3 {
    margin: 0;
  }

  .helper-toggle {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9em;
    color: var(--muted);
    cursor: pointer;
  }

  .helper-toggle input {
    margin: 0;
  }

  .inline-guide-title {
    font-weight: 600;
    margin: 0 0 6px 0;
  }

  .inline-guide {
    margin: 0 0 12px 0;
    padding-left: 1.2rem;
    font-size: 0.9em;
    color: var(--muted);
  }

  .inline-guide li {
    margin-bottom: 0.35rem;
  }

  .inline-guide li:last-child {
    margin-bottom: 0;
  }

  .col-helper {
    display: block;
    font-size: 0.75em;
    color: var(--muted);
    margin-top: 4px;
  }

  .helpers-hidden .inline-guide,
  .helpers-hidden .inline-guide-title,
  .helpers-hidden .col-helper {
    display: none !important;
  }
</style>
{% endblock %}

{% block scripts %}
<script>
(function(){
  // Compute button functionality
  const computeBtn = document.getElementById('computeBtn');
  const adviserSelect = document.getElementById('adviserSelect');
  const agreementDateInput = document.getElementById('agreementStartDate');
  const loadingDiv = document.getElementById('loading');

  if (computeBtn && adviserSelect && agreementDateInput) {
    // Set initial adviser selection if we have one
    const currentSelected = "{{ selected }}";
    if (currentSelected) {
      adviserSelect.value = currentSelected;
    }

    computeBtn.addEventListener('click', function() {
      const selectedAdviser = adviserSelect.value;
      const agreementDate = agreementDateInput.value;
      
      if (!selectedAdviser) {
        alert('Please select an adviser');
        return;
      }
      
      if (!agreementDate) {
        alert('Please select an agreement start date');
        return;
      }

      // Show loading state
      loadingDiv.style.display = 'block';
      computeBtn.disabled = true;
      computeBtn.textContent = 'Computing...';

      // Build URL with parameters (include all advisers)
      const params = new URLSearchParams({
        compute: '1',
        email: selectedAdviser,
        agreement_start_date: agreementDate,
        include_no: '1'
      });

      // Redirect to same page with compute parameters
      window.location.href = '?' + params.toString();
    });
  }

  const helperToggle = document.getElementById('toggleHelpers');
  if (helperToggle) {
    const applyHelperState = () => {
      document.body.classList.toggle('helpers-hidden', !helperToggle.checked);
    };
    helperToggle.addEventListener('change', applyHelperState);
    applyHelperState();
  }

  // Edit functionality
  const editBtn=document.getElementById('toggle-edit');
  const doneBtn=document.getElementById('done-edit');
  const resetBtn=document.getElementById('reset-edit');
  const table=document.querySelector('table');
  if(!table) return;

  function getNumFromCell(td){
    if(!td) return 0;
    const input = td.querySelector('input');
    const raw = input ? input.value : (td.dataset.value || td.textContent || '0');
    const n = parseFloat(String(raw).replace(/[^0-9.-]/g,''));
    return isNaN(n) ? 0 : n;
  }

  function recalc(){
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    let prevClarify = 0;
    rows.forEach(tr => {
      const tdClarify = tr.querySelector('td[data-field="clarify"]');
      const tdTarget  = tr.querySelector('td[data-field="target"]');
      const tdActual  = tr.querySelector('td[data-field="actual"]');
      const tdDiff    = tr.querySelector('td[data-field="diff"]');
      const tdOoo     = tr.children[3];
      const oooRaw    = (tdOoo ? tdOoo.textContent : '').trim().toLowerCase();
      const isFull    = oooRaw.startsWith('full');
      const c = getNumFromCell(tdClarify);
      const t = getNumFromCell(tdTarget);

      if (isFull) {
        const diff = 0 - t;
        if(tdActual) tdActual.textContent = '0';
        if(tdDiff) tdDiff.textContent = String(diff);
        return;
      }

      const actual = c + prevClarify;
      const diff = actual - t;
      if(tdActual) tdActual.textContent = String(actual);
      if(tdDiff) tdDiff.textContent = String(diff);
      prevClarify = c;
    });
  }

  function enterEdit(){
    doneBtn.style.display='inline-block';
    resetBtn.style.display='inline-block';
    editBtn.style.display='none';
    Array.from(table.querySelectorAll('tbody tr')).forEach(tr => {
      ['clarify','deals'].forEach(f => {
        const td = tr.querySelector(`td[data-field="${f}"]`);
        if(!td) return;
        const val = (td.dataset.value || td.textContent || '0').trim();
        td.dataset.value = val;
        if(!td.dataset.original){ td.dataset.original = val; }
        td.innerHTML = `<input type="number" min="0" step="1" value="${val}">`;
      });
    });
    recalc();
  }

  function exitEdit(){
    doneBtn.style.display='none';
    resetBtn.style.display='none';
    editBtn.style.display='inline-block';
    Array.from(table.querySelectorAll('tbody tr')).forEach(tr => {
      ['clarify','deals'].forEach(f => {
        const td = tr.querySelector(`td[data-field="${f}"]`);
        if(!td) return;
        const input = td.querySelector('input');
        const val = input ? input.value : (td.textContent || '0');
        td.textContent = val;
        td.dataset.value = val;
      });
    });
    recalc();
  }

  function resetEdit(){
    Array.from(table.querySelectorAll('tbody tr')).forEach(tr => {
      ['clarify','deals'].forEach(f => {
        const td = tr.querySelector(`td[data-field="${f}"]`);
        if(!td) return;
        const orig = td.dataset.original || td.dataset.value || '0';
        const input = td.querySelector('input');
        if(input){ input.value = orig; }
        td.dataset.value = orig;
      });
    });
    recalc();
  }

  function onInput(e){
    const el = e.target;
    if(el && el.tagName === 'INPUT') recalc();
  }

  if(editBtn) editBtn.addEventListener('click', enterEdit);
  if(doneBtn) doneBtn.addEventListener('click', exitEdit);
  if(resetBtn) resetBtn.addEventListener('click', resetEdit);
  table.addEventListener('input', onInput);
})();
</script>
{% endblock %}
